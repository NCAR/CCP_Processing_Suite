#!/bin/sh
#
# Process CCSM history netCDF files into single-field format and/or IPCC format
#
# --------------------------------------------------------------------------------
# User-settable parameters
# --------------------------------------------------------------------------------
# Case(s)
#
CASES="b30.097b"
#
# Type(s) - one of "atmm atmd lndm ocnm icem"
#
TYPES="atmm"
#
# Whether or not to do IPCC processing (zero means DO NOT, non-zero means DO)
#
DO_IPCC=0 ; export DO_IPCC
#
# Whether or not to do single-field processing (zero means DO NOT, non-zero means DO)
# one for each type above
#
DO_PROC=1 ; export DO_PROC
#
CURDIR=$PWD
#
for CASE in $CASES ; do
  for TYPE in $TYPES ; do
# --------------------------------------------------------------------------------
# Set up all necessary script variables
# --------------------------------------------------------------------------------
#
    source ./process_setup $CASE $TYPE
    if [ $? -ne 0 ] ; then
      echo "ERROR in setting up "$CASE" "$TYPE" processing. EXITING. FIX."
      exit 1
    fi
#
    cd $PROCDIR
    YEARNOW=$YEARBEG
    while [ $YEARNOW -le $YEAREND ] ; do
      YRCHECK=.done.$PROCCASE.$HISTNAM.$YEARNOW
      if [ ! -f $YRCHECK ] ; then
        echo "Processing "$PROCCASE"."$HISTNAM"."$YEARNOW" at "`date`
        MSFILES=$PROCCASE.$HISTNAM.$YEARNOW-{01,02,03,04,05,06,07,08,09,10,11,12}.nc
        ./mss_read $MSSHIST $MSFILES
        if [ $? -ne 0 ] ; then
          echo "Error from mss_read of "$MSFILES
          exit 1
        else
          for FILE in `ls $PROCCASE.$HISTNAM.$YEARNOW-??.nc` ; do
            if [ $DO_IPCC -ne 0 ] ; then
              ./create_ipcc_data $FILE
              if [ $? -ne 0 ] ; then
                echo "Error from create_ipcc_data on file "$FILE
                exit 1
              else
                touch .ipcc.$FILE
              fi
            fi
            if [ $DO_PROC -ne 0 ] ; then
              ./var_split $FILE erase
              if [ $? -ne 0 ] ; then
                echo "Error from ccsm_var_split on file "$FILE
                exit 1
              else
                touch .proc.$FILE
              fi
            fi
            if [ -f .proc.$FILE ] || [-f .ipcc.$FILE ] ; then
              touch .done.$FILE
            fi
          done
        fi
      fi
      if [ `ls .done.$PROCCASE.$HISTNAM.$YEARNOW-??.nc | wc -l` -eq 12 ] ; then
        touch $YRCHECK
      fi
      YEARNOW=`expr $YEARNOW + 1`
    done
#
# Concatenate months -> years, years -> decades, decades -> all
#
#    ./concatenate_data
#
# Store completed data on archival system
#
    ./store_to_archive
#
  cd $CURDIR
  done # TYPE
done # CASE
#
exit
