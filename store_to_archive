#!/bin/sh
#
# Store data on archival system
#
if [ $# -ne 0 ] ; then
  echo "Usage: store_to_archive"
  ./procstat.sh error store_to_archive
  exit 1
fi
#
if [ $DO_PROC ] ; then
  if [ $DO_PROC -ne 0 ] ; then
    cd $CACHEDIR
    if [ `ls *.nc | wc -l` != 0 ] ; then
      LAST=`ls -1 | egrep "\.${CASE}\." | egrep '\.nc$' | tail -n 1`
      while [ -f $LAST ] ; do
        for cfile in `ls *${CASE}.*nc | head -n 5` ; do
          if [ `echo $cfile | cut -c1-4` == "CAT." ] ; then
            SFILE=`echo $cfile | sed -e 's/^CAT\.//g'`
            mv $cfile $SFILE
          else
            SFILE=`echo $cfile`
          fi
          ../mss_write $SFILE $ARCHIVE_PROC
        done
        wait
      done
    fi
  fi
fi
#
if [ $DO_CMIP ] ; then
  if [ $DO_CMIP -ne 0 ] ; then
    cd $LOCAL_PROC/CMIP
    if [ `ls *.nc | wc -l` != 0 ] ; then
      if [ "$CMIP" = "cm5" ] ; then
        LAST=`ls -1 *-*.nc | tail -n 1`
        while [ -f $LAST ] ; do
          for cfile in `ls *-*.nc | head -n 5` ; do
            ../mss_write $cfile $ARCHIVE_CMIP
          done
          wait
        done
      fi
      if [ "$CMIP" = "cm3" ] ; then
        LAST=`ls *nc | tail -n 1`
        while [ -f $LAST ] ; do
          for cfile in `ls *nc | head -n 5` ; do
            ../mss_write $cfile $ARCHIVE_CMIP
          done
          wait
        done
      fi
    fi
  fi
fi
#
cd $LOCAL_PROC
