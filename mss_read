#!/bin/sh
# Read file(s) from a archival system
#
if [ $# -ne 1 ] ; then
  echo "Usage: mss_read MSSLIST"
  echo "Requires YEARNOW CASE HISTNAM TYPE be defined"
  exit 1
else
  MSSLIST=$1
fi
if ! [ -f $MSSLIST ] ; then
  echo "mss_read: No "$MSSLIST" file found. Exit."
  exit 1
fi
#
# Deduce files to read
#
CHEK=`echo $CASE | cut -d"." -f3 | cut -c1-2`
if [ ! $CHEK ] ; then
  DAT=`/bin/egrep "$HISTNAM.$YEARNOW" $MSSLIST | cut -d"." -f5-`
else
  DAT=`/bin/egrep "$HISTNAM.$YEARNOW" $MSSLIST | cut -d"." -f6-`
fi
#
LST=`echo $DAT | sed -e "s/ /,/g"`
if [ `echo $LST | cut -d"." -f2` = "tar" ] ; then
  MSSFILES=$CASE.$HISTNAM.${LST}
else
  MSSFILES=$CASE.$HISTNAM."{"${LST}"}"
fi
echo $MSSFILES
#
# If NCAR MSS msrcp command exists, use it.
TEST4MSRCP=`which msrcp 2<&1 >& /dev/null`
if [ $? -eq 0 ] ; then
   msrcp -overwrite sizemismatch mss:"$MSSHIST/$MSSFILES" .
   if [ $? -ne 0 ] ; then
     echo "Error on msrcp -overwrite sizemismatch mss:"$MSSHIST"/"$MSSFILES
     exit 1
   fi
#
# If NERSC/ORNL hsi command exists, use it.
else
  TEST4HSI=`which hsi 2<&1 >& /dev/null`
  if [ $? -eq 0 ] ; then
    if [ `echo $LST | cut -d"." -f2` = "tar" ] ; then
      htar -x -f $MSSHIST/$MSSFILES
      if [ $? -ne 0 ] ; then
        hsi -q "get -U $MSSHIST/$MSSFILES" >& /dev/null
        if [ $? -eq 0 ] ; then
          tar xf $MSSFILES
          if [ $? -ne 0 ] ; then
            echo "htar and tar extraction failed on "$MSSFILES
            exit 1
          else
            rm -f  $MSSFILES
          fi
        else
          echo "Error on hsi get of "$MSSHIST"/"$MSSFILES
          exit 1
        fi
      fi
    else
      hsi -q "get $MSSHIST/$MSSFILES" >& /dev/null
      if [ $? -ne 0 ] ; then
        echo "Error on hsi get of "$MSSHIST"/"$MSSFILES
        exit 1
      fi
    fi
  else
    echo "Neither msrcp nor hsi exist."
    exit 1
  fi
fi
