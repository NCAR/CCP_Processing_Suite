head	1.9;
access;
symbols;
locks;
comment	@# @;


1.9
date	2016.03.29.15.42.33;	author strandwg;	state Exp;
branches;
next	1.8;

1.8
date	2014.08.14.17.40.35;	author strandwg;	state Exp;
branches;
next	1.7;

1.7
date	2012.11.26.16.21.38;	author strandwg;	state Exp;
branches;
next	1.6;

1.6
date	2012.06.14.03.33.03;	author strandwg;	state Exp;
branches;
next	1.5;

1.5
date	2012.06.11.17.18.36;	author strandwg;	state Exp;
branches;
next	1.4;

1.4
date	2012.05.31.14.53.31;	author strandwg;	state Exp;
branches;
next	1.3;

1.3
date	2012.05.30.17.54.22;	author strandwg;	state Exp;
branches;
next	1.2;

1.2
date	2012.04.12.17.57.12;	author strandwg;	state Exp;
branches;
next	1.1;

1.1
date	2012.03.05.22.28.45;	author strandwg;	state Exp;
branches;
next	;


desc
@@


1.9
log
@*** empty log message ***
@
text
@program Omon_CMOR
  ! Convert CCSM4 ocn monthly (pop.h) data from single-field format
  ! to CMOR-compliant format
  !
  ! NOTE: 'model_id' and first part of 'source' MUST MATCH or CMOR will throw error
  !
  use cmor_users_functions
  use counters_netcdf_jfl
  use interfaces_netcdf_jfl
  use definitions_netcdf_jfl
  use exp_info
  use files_info
  use table_info
  use xwalk_info
  use grid_info
  use output_times_info
  use mycmor_info
  !
  implicit none
  !
  real,parameter::rho_0 = 1.0 ! 1 g/cm^3 instead of PD since we have a Boussinesq model
  !
  !  uninitialized variables used in communicating with CMOR:
  !
  integer::error_flag,cmor_var_id
  real,dimension(1)::zostoga
  real,dimension(:)    ,allocatable::indat1a
  real,dimension(:,:)  ,allocatable::indat2a,indat2b,indat2c,icefrac,cmordat2d
  real,dimension(:,:,:),allocatable::indat3a,indat3b,indat3c,cmordat3d,work3da,work3db,volume
  real,dimension(:,:,:,:),allocatable::indat4a ! MOC
  double precision,dimension(:)  ,allocatable::time
  double precision,dimension(:,:),allocatable::time_bnds
  double precision,dimension(1)  ::tval
  double precision,dimension(2,1)::tbnd
  !
  ! Other variables
  !
  character(len=256)::exp_file,xwalk_file,table_file,svar,tstr,original_name,logfile,cmor_filename
  character(len=256)::fcase,fcomp,fsvar,ftime
  integer::i,j,k,m,n,it,ivar,jvar,length,iexp,jexp,ixw,ilev,ic,tcount
  real::spval
  logical::does_exist
  !
  ! GO!
  !
  mycmor%table_file = 'Omon'
  !
  ! Get experiment information
  !
  exp_file = 'experiments.txt'
  call load_exp(exp_file)
  !
  read(*,*) case_read
  read(*,*) comp_read
  !
  ! Get experiment metadata from exp table and input case information
  !
  call get_exp_metadata
  !
  ! Get "crossxwalk" (xwalk) information
  !   Provides information on relationship between CMOR variables and
  !   model variables
  !
  xwalk_file = 'xwalk_'//trim(exp(exp_found)%cmip)//'_'//trim(mycmor%table_file)
  call load_xwalk(xwalk_file)
  !
  ! Get table information
  !
  mycmor%table_file = 'Tables/'//trim(exp(exp_found)%cmip)//'_'//trim(mycmor%table_file)
  inquire(file=mycmor%table_file,exist=does_exist)
  if (.not.(does_exist)) then
     write(*,*) 'Cannot find ',trim(mycmor%table_file),'. Dying.'
     stop
  endif
  !
  ! Get grid information
  !
  call get_ocn_grid
  !
  ! Set up CMOR subroutine arguments
  !
  call get_cmor_info
  !
  ! Parse RIP code into components
  !
  call parse_rip
  !
  ! Step through CMOR table entries to see what CESM fields we can read and in process, and if so, do it!
  !
  xwalk_loop: do ixw = 1,num_xw
     call reset_netcdf_var
     mycmor%positive = ' '
     error_flag      = 0
     time_units      = ' '
     !
     ! The meaty part
     !
     if (xw(ixw)%ncesm_vars==0) then
        write(*,'(a,'' is UNAVAILABLE.'')') trim(xw(ixw)%entry)
        all_continue = .false.
     endif
     !
     do ivar = 1,xw(ixw)%ncesm_vars
        if (trim(xw(ixw)%cesm_vars(ivar))=='UNKNOWN') then
           write(*,'(a,'' has UNKNOWN equivalence.'')') trim(xw(ixw)%entry)
           xw(ixw)%ncesm_vars = 0
           all_continue = .false.
        else
           write(*,'(''CHECKING AVAILABILITY OF: '',a,''.'',a,''.'',a,''.* FILES'')') trim(case_read),trim(comp_read),trim(xw(ixw)%cesm_vars(ivar))
           call build_filenames(case_read,comp_read,xw(ixw)%cesm_vars(ivar),ivar,exp(exp_found)%runbeg,exp(exp_found)%runend,mycmor%table_file)
        endif
     enddo
     !
     ! Open CESM file(s) and get information(s)
     !
     if (all_continue) then
        call open_cdf(myncid(1,1),trim(ncfile(1,1)),.true.)
        call get_dims(myncid(1,1))
        call get_vars(myncid(1,1))
        call read_att_text(myncid(1,1),'time','units',time_units)
        write(*,'(''time units in: '',i10,5x,a)') myncid(1,1),trim(time_units)
        call close_cdf(myncid(1,1))
        do ivar = 1,xw(ixw)%ncesm_vars
           do ifile = 1,nc_nfiles(ivar)
              call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
              call get_dims(myncid(ifile,ivar))
              call get_vars(myncid(ifile,ivar))
              !
              do n=1,dim_counter
                 length = len_trim(dim_info(n)%name)
                 if(dim_info(n)%name(:length).eq.'time') then
                    ntimes(ifile,ivar) = dim_info(n)%length
                 endif
              enddo
!              call read_att_text(myncid(ifile,ivar),'time','units',time_units)
!              write(*,'(''time units in: '',i10,5x,a)') myncid(ifile,ivar),trim(time_units)
              !
              do n=1,var_counter
                 if (trim(var_info(n)%name)==trim(xw(ixw)%cesm_vars(ivar))) then
                    var_found(ifile,ivar) = n
                    xw_found = ixw
                 endif
              enddo
              if (var_found(ifile,ivar)==0) then
                 write(*,'(''NEVER FOUND: '',a,'' STOP. '')') trim(xw(ixw)%cesm_vars(ivar))
                 stop
              endif
           enddo
        enddo
        !
        myncid = 0
        !
        ! Specify path where tables can be found and indicate that existing netCDF files should be overwritten.
        !
        write(logfile,'(''log_cmor.'',a,''.'',a,''.'',a,''_'',a)') &
             trim(mycmor%model_id),&
             trim(mycmor%experiment_id),&
             trim(exp(exp_found)%rip_code),&
             trim(xw(ixw)%entry)
        error_flag = cmor_setup(inpath='CMOR',&
             netcdf_file_action=CMOR_REPLACE,&
             logfile=logfile)
        table_ids(1) = cmor_load_table(mycmor%table_file)
        call cmor_set_table(table_ids(1))
        !
        error_flag = cmor_dataset(                              &
             outpath=mycmor%outpath,                            &
             experiment_id=mycmor%experiment_id,                &
             institution=mycmor%institution,                    &
             source=mycmor%source,                              &
             calendar=mycmor%calendar,                          &
             realization=mycmor%realization,                    &
             contact=mycmor%contact,                            &
             history=mycmor%history,                            &
             comment=mycmor%comment,                            &
             references=mycmor%references,                      &
             model_id=mycmor%model_id,                          &
             forcing=mycmor%forcing,                            &
             initialization_method=mycmor%initialization_method,&
             physics_version=mycmor%physics_version,            &
             institute_id=mycmor%institute_id,                  &
             parent_experiment_id=mycmor%parent_experiment_id,  &
             parent_experiment_rip=mycmor%parent_experiment_rip,&
             branch_time=mycmor%branch_time)
        if (error_flag < 0) then
           write(*,*) 'ERROR on cmor_dataset!'
           write(*,*) 'outpath               = ',mycmor%outpath
           write(*,*) 'experiment_id         = ',mycmor%experiment_id
           write(*,*) 'institution           = ',mycmor%institution
           write(*,*) 'source                = ',mycmor%source
           write(*,*) 'calendar              = ',mycmor%calendar
           write(*,*) 'realization           = ',mycmor%realization
           write(*,*) 'contact               = ',mycmor%contact
           write(*,*) 'history               = ',mycmor%history
           write(*,*) 'comment               = ',mycmor%comment
           write(*,*) 'references            = ',mycmor%references
           write(*,*) 'model_id              = ',mycmor%model_id
           write(*,*) 'forcing               = ',mycmor%forcing
           write(*,*) 'initialization_method = ',mycmor%initialization_method
           write(*,*) 'physics_version       = ',mycmor%physics_version
           write(*,*) 'institute_id          = ',mycmor%institute_id
           write(*,*) 'parent_experiment_id  = ',mycmor%parent_experiment_id
           write(*,*) 'parent_experiment_rip = ',mycmor%parent_experiment_rip
           write(*,*) 'branch_time           = ',mycmor%branch_time
        endif
        !
        ! Add global metadata
        !
        call add_global_metadata
        !
        ! Define axes via 'cmor_axis'
        !
        table_ids(2) = cmor_load_table('Tables/CMIP5_grids')
        table_ids(3) = cmor_load_table('Tables/CMIP5_fx')
        call cmor_set_table(table_ids(2))
        call define_ocn_axes(xw(ixw)%dims)
        call cmor_set_table(table_ids(1))
        ! 
        ! Make manual alterations so that CMOR works. Silly code!
        !
        if (xw(ixw)%ncesm_vars==1) then
           write(original_name,'(a)') xw(ixw)%cesm_vars(1)
        endif
        if (xw(ixw)%ncesm_vars==2) then
           write(original_name,'(a,'','',a)') (trim(xw(ixw)%cesm_vars(jvar)),jvar=1,xw(ixw)%ncesm_vars)
        endif
        if (xw(ixw)%ncesm_vars==3) then
           write(original_name,'(a,'','',a,'','',a)') (trim(xw(ixw)%cesm_vars(jvar)),jvar=1,xw(ixw)%ncesm_vars)
        endif
        !
        ! Modify units as necessary to accomodate udunits' inability to convert 
        !
        select case (xw(ixw)%entry)
        case ('msftmyz','msftmyzba','msftbarot','wmo','umo','vmo')
           var_info(var_found(1,1))%units = 'kg s-1'
        case ('wmosq')
           var_info(var_found(1,1))%units = 'kg2 s-2'
        case ('so','sos','soga')
           var_info(var_found(1,1))%units = 'psu'
        case ('masso')
           var_info(var_found(1,1))%units = 'kg'
        case ('cfc11')
           var_info(var_found(1,1))%units = 'mol kg-1'
        case ('fbddtalk','fddtalk','intpp','frn','intppico','intpcalc','intpdiat','intpdiaz','intpn2','intpbsi','intpcalcite')
           var_info(var_found(1,1))%units = 'mol m-2 s-1'
        case ('talk')
           var_info(var_found(1,1))%units = 'mol m-3'
        case ('ph')
           var_info(var_found(1,1))%units = '1'
        case ('dpco2','spco2')
           var_info(var_found(1,1))%units = 'Pa'
        case ('fgco2')
           var_info(var_found(1,1))%units = 'kg m-2 s-1'
           mycmor%positive = 'down'
        case ('intdic')
           var_info(var_found(1,1))%units = 'kg m-2'
        case ('hfss','rlds','rsntds','rsds','tauuo','tauvo')
           mycmor%positive = 'up'
        case ('hfds')
           mycmor%positive = 'down'
        case ('epc100','epcalc100','epfe100','epsi100','fgo2','fsn')
           mycmor%positive = 'down'
        end select
        !
        write(*,*) 'calling cmor_variable:'
        write(*,*) 'table         = ',trim(mycmor%table_file)
        write(*,*) 'table_entry   = ',trim(xw(ixw)%entry)
        write(*,*) 'dimensions    = ',trim(xw(ixw)%dims)
        write(*,*) 'units         = ',trim(var_info(var_found(1,1))%units)
        write(*,*) 'axis_ids      = ',axis_ids(1:naxes)
        write(*,*) 'missing_value = ',var_info(var_found(1,1))%missing_value
        write(*,*) 'positive      = ',trim(mycmor%positive)
        write(*,*) 'original_name = ',trim(original_name)
        !
        select case (xw(ixw)%entry)
        case ('thetao','so','agessc','uo','vo','rhopoto','cfc11','wmo','wmosq','umo','vmo')
           ! Full-column fields
           cmor_var_id = cmor_variable(                            &
                table=mycmor%table_file,                           &
                table_entry=xw(ixw)%entry,                         &
                units=var_info(var_found(1,1))%units,              &
                axis_ids=(/grid_id(1),axis_ids(3),axis_ids(4)/),   &
                missing_value=var_info(var_found(1,1))%missing_value,&
                positive=mycmor%positive,                          &
                original_name=original_name,                       &
                comment=xw(ixw)%comment)
        case ('msftmyz','msftmyzba')
           ! Different MOC grid
           cmor_var_id = cmor_variable(                            &
                table=mycmor%table_file,                           &
                table_entry=xw(ixw)%entry,                         &
                units=var_info(var_found(1,1))%units,              &
                axis_ids=(/axis_ids(1),axis_ids(2),axis_ids(3),axis_ids(4)/),   &
                missing_value=var_info(var_found(1,1))%missing_value,&
                positive=mycmor%positive,                          &
                original_name=original_name,                       &
                comment=xw(ixw)%comment)
        case ('soga','thetaoga','zosga','zossga','zostoga','masso')
           ! Time-dependent-only fields
           cmor_var_id = cmor_variable(                            &
                table=mycmor%table_file,                           &
                table_entry=xw(ixw)%entry,                         &
                units=var_info(var_found(1,1))%units,              &
                axis_ids=(/axis_ids(1)/),                          &
                missing_value=var_info(var_found(1,1))%missing_value,&
                positive=mycmor%positive,                          &
                original_name=original_name,                       &
                comment=xw(ixw)%comment)
        case ('dpco2','fgco2','fgo2','frn','fsn','intdic','intpbsi','intpcalcite','intpcalc','intpdiat','intpdiaz',&
              'intpn2','intpnitrate','intppico','intpp','o2min','spco2','zo2min','zsatarag','zsatcalc','hfss',&
              'msftbarot','omlmax','pr','prsn','rlds','rsntds','sos','tauuo','tauvo','tos','tossq','zos','zossq',&
              'chlcalc','chldiat','chldiaz','chl','chlpico','co3','co3satarag','co3satcalc','dfe','dissic','dissoc',&
              'epc100','epcalc100','epfe100','epsi100','nh4','no3','o2','ph','phycalc','phyc','phydiat','phydiaz',&
              'phyfe','phyn','phypico','phyp','physi','po4','si','talk','zooc','hfds',&
              'fbddtalk','fbddtdic','fbddtdife','fbddtdin','fbddtdip','fbddtdisi','fddtalk',&
              'fddtdic','fddtdife','fddtdin','fddtdip','fddtdisi')
           ! Single-level fields
           cmor_var_id = cmor_variable(                            &
                table=mycmor%table_file,                           &
                table_entry=xw(ixw)%entry,                         &
                units=var_info(var_found(1,1))%units,              &
                axis_ids=(/grid_id(1),axis_ids(3)/),               &
                missing_value=var_info(var_found(1,1))%missing_value,&
                positive=mycmor%positive,                          &
                original_name=original_name,                       &
                comment=xw(ixw)%comment)
        end select
        if (abs(cmor_var_id) .gt. 1000) then
           write(*,'(''Invalid call to cmor_variable, table_entry, varid: '',a,2x,i10)') trim(xw(ixw)%entry),cmor_var_id
           cycle xwalk_loop
        else
           write(*,'(''called cmor_variable, table_entry, varid: '',a,2x,i10)') trim(xw(ixw)%entry),cmor_var_id
        endif
        !
        ! Perform derivations and cycle through time, writing data too
        !
        select case (xw(ixw)%entry)
        case ('chldiat','chldiaz','chlpico','co3','co3satarag','co3satcalc','dfe','tos','ph',&
              'dissic','dissoc','nh4','no3','o2','phycalc','phydiat','phydiaz','phypico',&
              'physi','po4','si','zooc')
           !
           ! All fields at at k=1 (depth0m or so)
           !
           if (.not.(allocated(indat3a)))   allocate(indat3a(nlons,nlats,nlevs))
           if (.not.(allocated(cmordat2d))) allocate(cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n = 1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              !
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    cmordat2d = indat3a(:,:,1)
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i8,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('sos')
           !
           ! sos: SALT at k=1, times 1000
           !
           if (allocated(indat3a))   deallocate(indat3a)
           if (allocated(cmordat2d)) deallocate(cmordat2d)
           allocate(indat3a(nlons,nlats,nlevs))
           allocate(cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n = 1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    cmordat2d = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (indat3a(i,j,1).ne.var_info(var_found(ifile,1))%missing_value) then
                             cmordat2d(i,j) = 1.e3*indat3a(i,j,1)
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',2i8,'' chunk# '',i6)') trim(xw(ixw)%entry),tcount-1,it-1,ic
                 if (trim(case_read) == 'b40.lm850-1850.1deg.001') then
                    if (ifile == 50) then
                       error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                       if (error_flag < 0) then
                          write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                       else
                          write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                       endif
                    endif
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('talk')
           !           !
           ! ALK fields at at k=1 (depth0m) and converted from meq/m3 to mol m-3 via * 1.e-3
           !
           if (.not.(allocated(indat3a)))   allocate(indat3a(nlons,nlats,nlevs))
           if (.not.(allocated(cmordat2d))) allocate(cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n = 1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152 ) ! RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    cmordat2d = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             cmordat2d(i,j) = indat3a(i,j,1)*1.e-3
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i8,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('fbddtalk','fddtalk')
           !
           ! Convert meq/m3 cm/s to mol m-2 s-1 via * 1.e-5
           !
           allocate(indat2a(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152 ) ! RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12000/)
                 endif
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i6,''-'',i6),1x))') nchunks(1),(tidx1(ic),tidx2(ic),ic=1,nchunks(1))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat2a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             indat2a(i,j) = indat2a(i,j) * 1.e-5
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat2a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('dpco2','spco2')
           !
           ! Convert ppmv to Pa via * 0.101325
           !
           allocate(indat2a(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    nchunks(ifile) = 1
                    if (ftime( 1:4) == '0001') tidx1(1:nchunks(ifile)) = 3589
                    if (ftime( 1:4) == '0300') tidx1(1:nchunks(ifile)) =   13
                    if (ftime(8:11) == '1000') tidx2(1:nchunks(ifile)) = 9600
                    if (ftime(1: 4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152 ) ! RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 1
                    tidx1(1:nchunks(ifile)) = (/3601/)
                    tidx2(1:nchunks(ifile)) = (/9600/)
                 endif
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i6,''-'',i6),1x))') nchunks(1),(tidx1(ic),tidx2(ic),ic=1,nchunks(1))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat2a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             indat2a(i,j) = indat2a(i,j) * 0.101325
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat2a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('fgco2')
           !
           ! Convert mmol/m3 cm/s to kg m-2 s-1 via * 12.0e-8
           !
           allocate(indat2a(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152 ) ! RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1

                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 1
                    tidx1(1:nchunks(ifile)) = (/3601/)
                    tidx2(1:nchunks(ifile)) = (/9600/)
                 endif
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i6,''-'',i6),1x))') nchunks(1),(tidx1(ic),tidx2(ic),ic=1,nchunks(1))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat2a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             indat2a(i,j) = indat2a(i,j) * 12.0e-8
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat2a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('tauuo','tauvo','hfss','pr','prsn','rsds','rsntds','zos','omlmax',&
              'fbddtdic','fbddtdife','fbddtdip','fbddtdisi','zossq',&
              'fddtdic','fddtdife','fddtdip','fddtdisi','fgo2',&
              'o2min','zo2min','zsatarag','zsatcalc')
           !
           ! No changes - just pass through
           !
           allocate(indat2a(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 1
                    tidx1(1:nchunks(ifile)) = (/3601/)
                    tidx2(1:nchunks(ifile)) = (/9600/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i6,''-'',i6),1x))') nchunks(1),(tidx1(ic),tidx2(ic),ic=1,nchunks(1))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat2a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat2a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 if (trim(case_read) == 'b40.lm850-1850.1deg.001') then
                    if (ifile == 6) then
                       error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                       if (error_flag < 0) then
                          write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                       else
                          write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                       endif
                    endif
                 endif
              enddo
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('msftbarot')
           !
           ! msftbarot: Convert BSF from Sv to kg s-1
           !
           if (allocated(indat2a)) deallocate(indat2a(nlons,nlats))
           allocate(indat2a(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat2a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             indat2a(i,j) = indat2a(i,j) * (1.e6 * 1000.) ! 10^6 m3 s-1 to kg s-1
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat2a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                 else
                    write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('thetao','agessc','uo','vo','rhopoto')
           !
           ! No changes
           !
           allocate(indat3a(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              !
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat3a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
           enddo
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('cfc11')
           !
           ! cfc11 - convert fmol/cm^3 to mol kg-1
           !
           allocate(indat3a(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j) == k) then
                                indat3a(i,j,k) = indat3a(i,j,k) / 1.e12
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat3a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
           enddo
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('wmo','wmosq')
           !
           ! wmo,wmosq: 0.5 * (WVEL(i,j,k) + WVEL(i,j,k+1)) * TAREA(i,j) * rho_0
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    cmordat3d = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs-1
                       do j = 1,nlats
                          do i = 1,nlons
                             if (indat3a(i,j,k) /= var_info(var_found(ifile,1))%missing_value) then
                                cmordat3d(i,j,k) = ((0.5*(indat3a(i,j,k)+indat3a(i,j,k+1)))*ocn_t_area(i,j)*rho_0)/1000. ! g s-1 to kg s-1
                             else
                                cmordat3d(i,j,k) = var_info(var_found(ifile,1))%missing_value
                             endif
                          enddo
                       enddo
                    enddo
                    cmordat3d(:,:,nlevs) = 0.
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat3d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('umo')
           !
           ! umo: 0.5 * (UVEL(i,j) + UVEL(i,j-1)) * HTE(i,j) * dz(k) * rho_0 (rho_0 = 1 g cm-3)
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    cmordat3d = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 2,nlats
                          do i = 1,nlons
                             if (indat3a(i,j,k) /= var_info(var_found(ifile,1))%missing_value) then
                                cmordat3d(i,j,k) = ((0.5*(indat3a(i,j,k)+indat3a(i,j-1,k)))*ocn_t_hte(i,j)*ocn_t_dz(k)*rho_0)/1000. ! g s-1 to kg s-1
                             else
                                cmordat3d(i,j,k) = var_info(var_found(ifile,1))%missing_value
                             endif
                          enddo
                       enddo
                    enddo
                    cmordat3d(:,1,:) = 0.
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat3d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('vmo')
           !
           ! vmo: 0.5 * (VVEL(i,j) + VVEL(i-1,j)) * HTN(i,j) * dz(k) * rho_0
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    cmordat3d = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 2,nlons
                             if (indat3a(i,j,k) /= var_info(var_found(ifile,1))%missing_value) then
                                cmordat3d(i,j,k) = ((0.5*(indat3a(i,j,k)+indat3a(i-1,j,k)))*ocn_t_htn(i,j)*ocn_t_dz(k)*rho_0)/1000. ! g s-1 to kg s-1
                             else
                                cmordat3d(i,j,k) = var_info(var_found(ifile,1))%missing_value
                             endif
                          enddo
                       enddo
                    enddo
                    do k = 1,nlevs
                       do j = 1,nlats
                          if (indat3a(1,j,k) /= var_info(var_found(ifile,1))%missing_value) &
                             cmordat3d(1,j,k) = ((0.5*(indat3a(1,j,k)+indat3a(nlons,j,k)))*ocn_t_htn(1,j)*ocn_t_dz(k)*rho_0)/1000. ! g s-1 to kg s-1
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat3d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('so')
           !
           ! so: SALT*1000 to handle CMOR change to psu bug
           !
           allocate(indat3a(nlons,nlats,nlevs))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = nint((float(ntimes(ifile,1))/120.))+1
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 1872 ) ! 20C from 1850-2005
                 nchunks(ifile) = 16
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              case ( 2664 ) ! FASTCHEM piControl from 70-291
                 nchunks(ifile) = 23
                 tidx1(1) =   1
                 tidx2(1) = 120
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
              case ( 900 ) ! 75 years, 1850-1924
                 nchunks(ifile) = 8
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241, 361, 481, 601, 721, 841/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, 360, 480, 600, 720, 840, 900/)
              case ( 300, 372, 312 ) ! 30 or 31 years
                 nchunks(ifile) = 3
                 tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                 tidx2(1:nchunks(ifile)) = (/120, 240, ntimes(ifile,1)/)
              case ( 360 ) ! 30 years
                 if ((exp(exp_found)%runbeg==2006).and.(exp(exp_found)%runend==2035)) then
                    nchunks(ifile) = 4
                    tidx1(1:nchunks(ifile)) = (/  1,  49, 169, 289/)
                    tidx2(1:nchunks(ifile)) = (/ 48, 168, 288, 360/)
                 else
                    nchunks(ifile) = 3
                    tidx1(1:nchunks(ifile)) = (/  1, 121, 241/)
                    tidx2(1:nchunks(ifile)) = (/120, 240, 360/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    indat3a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    where (indat3a /= var_info(var_found(ifile,1))%missing_value)
                       indat3a = indat3a*1.e3
                    endwhere
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = indat3a,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
           enddo
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('soga','thetaoga','masso')
           !
           ! soga     - global average salinity
           ! thetaoga - global average temperature
           ! masso    - total mass (kg)
           !
           allocate(indat3a(nlons,nlats,nlevs)) ! SALT or TEMP
           allocate(volume(nlons,nlats,nlevs))  ! Ocean volume (TAREA * dz), cm^3
           volume = 0.
           do j = 1,nlats
              do i = 1,nlons
                 do k = 1,nlevs
                    if (kmt(i,j).ge.k) then
                       volume(i,j,k) = ocn_t_area(i,j)*ocn_t_dz(k)
                    endif
                 enddo
              enddo
           enddo
!           write(*,'(''VOLUME (cm^3): '',3e20.10)') minval(volume),maxval(volume),sum(volume)
!           write(*,'(''VOLUME (km^3): '',3e20.10)') minval(volume)/1.e15,maxval(volume)/1.e15,sum(volume)/1.e15
           !
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
!              write(*,*) 'OPENING: ',myncid(ifile,1),trim(ncfile(ifile,1))
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              if (allocated(indat1a))    deallocate(indat1a)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              allocate(indat1a(ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              indat1a = 0.
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
!                    write(*,'(''TIME: '',i10,10x,f10.3)') it,time(it)
                    time_counter = it
                    indat3a = 1.e30
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 1,nlons
                             if (indat3a(i,j,k).lt.1.e30) indat1a(it) = indat1a(it) + (indat3a(i,j,k)*volume(i,j,k))
                          enddo
                       enddo
                    enddo
                 enddo
              enddo
              !
!              write(*,*) 'MIN: ',minval(indat1a),'MAX: ',maxval(indat1a)
              if (xw(ixw)%entry=='masso') then
                 indat1a = indat1a/1000.
              elseif (xw(ixw)%entry=='thetaoga') then
                 indat1a = indat1a/sum(volume)
              elseif (xw(ixw)%entry=='soga') then
                 indat1a = 1.e3*(indat1a/sum(volume))
              endif
              write(*,*) 'MIN: ',minval(indat1a),'MAX: ',maxval(indat1a)
              !
              error_flag = cmor_write(                &
                   var_id        = cmor_var_id,                  &
                   data          = indat1a(tidx1(1):tidx2(1)), &
                   ntimes_passed = ((tidx2(1)-tidx1(1))+1),    &
                   time_vals     = time(tidx1(1):tidx2(1)),    &
                   time_bnds     = time_bnds(:,tidx1(1):tidx2(1)))
              if (error_flag < 0) then
                 write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                 stop
              endif
              write(*,'(''DONE writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it-1
              if (allocated(indat1a))   deallocate(indat1a)
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('zosga','zossga','zostoga')
           !
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              write(*,*) 'OPENING: ',myncid(ifile,1),trim(ncfile(ifile,1))
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              if (allocated(indat1a))    deallocate(indat1a)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              allocate(indat1a(ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              !
              indat1a = 0.
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat1a(it))
                 enddo
              enddo
!              indat1a = indat1a/100.
              error_flag = cmor_write(                &
                   var_id        = cmor_var_id,                  &
                   data          = indat1a(tidx1(1):tidx2(1)), &
                   ntimes_passed = ((tidx2(1)-tidx1(1))+1),    &
                   time_vals     = time(tidx1(1):tidx2(1)),    &
                   time_bnds     = time_bnds(:,tidx1(1):tidx2(1)))
              if (error_flag < 0) then
                 write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                 stop
              endif
              write(*,'(''DONE writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it-1
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('rlds')
           !
           ! rlds: LWUP_F + LWDN_F where IFRAC = 0
           !
           allocate(indat2a(nlons,nlats),indat2b(nlons,nlats),icefrac(nlons,nlats),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat2b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,icefrac)
                    where (icefrac == 0)
                       where ((indat2a /= spval).and.(indat2b /= spval))
                          cmordat2d = indat2a + indat2b
                       elsewhere
                          cmordat2d = spval
                       endwhere
                    elsewhere
                       cmordat2d = spval
                    endwhere
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
           enddo
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('fddtdin','fddtdinrlds','fbddtdin','hfds')
           !
           ! Add two fields
           !
           allocate(indat2a(nlons,nlats),indat2b(nlons,nlats),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i6,''-'',i6),1x))') nchunks(1),(tidx1(ic),tidx2(ic),ic=1,nchunks(1))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat2b)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) cmordat2d(i,j) = indat2a(i,j) + indat2b(i,j)
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
           enddo
        case ('chl','phyc','phyfe')
           !
           ! Add three full-column fields, but use only topmost layer in sum
           !
           allocate(indat3a(nlons,nlats,nlevs),indat3b(nlons,nlats,nlevs),indat3c(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) cmordat2d(i,j) = indat3a(i,j,1) + indat3b(i,j,1) + indat3c(i,j,1)
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('phyp')
           !
           ! Add three 15-level fields, but use only topmost layer in sum
           ! phyp = (diatC+spC)*.00855+diazC*.002735
           !
           allocate(indat3a(nlons,nlats,15),indat3b(nlons,nlats,15),indat3c(nlons,nlats,15),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             cmordat2d(i,j) = ((indat3a(i,j,1)+indat3b(i,j,1))*0.00855) + &
                                               (indat3c(i,j,1)*0.002735)
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('phyn')
           !
           ! Add three 15-level fields, but use only topmost layer in sum
           ! phyp = (diatC+spC+diazC)*.137
           !
           allocate(indat3a(nlons,nlats,15),indat3b(nlons,nlats,15),indat3c(nlons,nlats,15),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) then
                             cmordat2d(i,j) = ((indat3a(i,j,1)+indat3b(i,j,1)+indat3c(i,j,1))*0.137)
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('chlcalc')
           !
           ! chlcalc: spChl*(spCaCO3/spC)
           !
           allocate(indat3a(nlons,nlats,15),indat3b(nlons,nlats,15),indat3c(nlons,nlats,15),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j) .ge. 1) cmordat2d(i,j) = indat3a(i,j,1) * (indat3b(i,j,1)/indat3c(i,j,1))
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('epc100','epcalc100','epfe100','epsi100')
           !
           ! Full-column fields, but use only "depth100m" meters; z_t at index 11 - 
           ! "Please sample those fields at 105m. In the model output, these fields are actually 
           ! fluxes into the top of the cell, and the top of the cell whose center is at 105m is at 100m."
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.ge.11)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (indat3a(i,j,11).ne.spval) then
                             cmordat2d(i,j) = indat3a(i,j,11)
                          endif
                       enddo
                    enddo
!!$                    do k = 10,nlevs
!!$                       do j = 1,nlats
!!$                          do i = 1,nlons
!!$                             if (indat3a(i,j,k).ne.spval) then
!!$                                cmordat2d(i,j) = cmordat2d(i,j)+(indat3a(i,j,k))
!!$                             endif
!!$                          enddo
!!$                       enddo
!!$                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('intdic')
           !
           ! Single full-column fields, integrate over all of z_t
           ! and convert from mmol/m3 to kg m-2 via *12.0e-8
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + ((indat3a(i,j,k)*12.0e-8)*ocn_t_dz(k))
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('frn')
           !
           ! Single full-column field, integrate over all of z_t
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + ((-1.0e-5*indat3a(i,j,k))*ocn_t_dz(k))
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('intpp')
           !
           ! Add three 15-level fields, integrate over z_t_150m, multiply by 1.e-5 to convert units
           !
           allocate(indat3a(nlons,nlats,15),indat3b(nlons,nlats,15),indat3c(nlons,nlats,15),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
                    do k = 1,15
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + &
                                     ((((indat3a(i,j,k)*ocn_t_dz(k))+&
                                       (indat3b(i,j,k)*ocn_t_dz(k))+&
                                       (indat3c(i,j,k)*ocn_t_dz(k))))*1.e-5)
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('fsn')
           !
           ! Add single-level fields and add another 15-level field, integrate it over z_t_150m,
           ! multiply by 1.e-5 to convert units
           ! NOx_FLUX + NHy_FLUX + (integrate diaz_Nfix over z_t_150m)
           !
           allocate(indat2a(nlons,nlats),indat2b(nlons,nlats),indat3a(nlons,nlats,15),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              if (ifile.eq.1) time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = merge(0.,spval,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat2b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3a)
                    do k = 1,15
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + ((indat3a(i,j,k)*ocn_t_dz(k))*1.e-5)
                             endif
                          enddo
                       enddo
                    enddo
                    do j = 1,nlats
                       do i = 1,nlons
                          if (kmt(i,j).ge.1) then
                             cmordat2d(i,j) = cmordat2d(i,j) + ((indat2a(i,j)+indat2b(i,j))*1.e-5)
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('intpcalc','intpdiat','intpdiaz','intpn2','intppico')
           !
           ! Integrate over z_t_150m
           !
           if (allocated(indat3a)) deallocate(indat3a)
           allocate(indat3a(nlons,nlats,15))
           if (allocated(cmordat2d)) deallocate(cmordat2d)
           allocate(cmordat2d(nlons,nlats))
           !
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    cmordat2d = merge(0.,1.e20,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,15
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + ((1.0e-5*indat3a(i,j,k))*ocn_t_dz(k))
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('intpcalcite','intpbsi')
           !
           ! Integrate -1*field over z_t_150m
           !
           if (allocated(indat3a)) deallocate(indat3a)
           allocate(indat3a(nlons,nlats,15))
           if (allocated(cmordat2d)) deallocate(cmordat2d)
           allocate(cmordat2d(nlons,nlats))
           !
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    cmordat2d = merge(0.,1.e20,kmt.gt.0)
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do k = 1,15
                       do j = 1,nlats
                          do i = 1,nlons
                             if (kmt(i,j).ge.k) then
                                cmordat2d(i,j) = cmordat2d(i,j) + ((-1.0e-5*indat3a(i,j,k))*ocn_t_dz(k))
                             endif
                          enddo
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
              enddo
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
           enddo
           !
           cmor_filename = ' '
           error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('intpnitrate')
           !
           ! Add three single-level fields
           !
           allocate(indat2a(nlons,nlats),indat2b(nlons,nlats),indat2c(nlons,nlats),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (allocated(time))       deallocate(time)
              if (allocated(time_bnds))  deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 8400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = (/   1/)
                 tidx2(1:nchunks(ifile)) = (/6000/)
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat2a)
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat2b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat2c)
                    where ((indat2a /= spval).and.(indat2b /= spval).and.(indat2c /= spval))
                       cmordat2d = indat2a + indat2b + indat2c
                    elsewhere
                       cmordat2d = spval
                    endwhere
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
              enddo
           enddo
           !
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
              stop
           else
              write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
              call close_cdf(myncid(ifile,2))
              call close_cdf(myncid(ifile,3))
           enddo
        case ('msftmyz')
           !
           ! msftmyz: MOC
           !
           ! moc_comp(1)="Eulerian Mean" 
           ! moc_comp(2)="Eddy-Induced (bolus)" 
           ! moc_comp(3)="Submeso" 
           ! 
           ! transport_reg(1):="Global Ocean - Marginal Seas" 
           ! transport_reg(2):="Atlantic Ocean + Mediterranean Sea + Labrador Sea + GIN Sea + Arctic Ocean + Hudson Bay" 
           !
           ! MOC:coordinates = "lat_aux_grid moc_z moc_components transport_region time"
           !
           !                Y           Z      comp      basin
           allocate(indat4a(nlats_trans,nmoc_z,nmoc_comp,ntrans_reg))
           !
           ! basin 1: 'atlantic_arctic_ocean'
           ! basin 2: 'indian_pacific_ocean'
           ! basin 3: 'global_ocean'
           !
           !                  Y           Z      basin
           allocate(cmordat3d(nlats_trans,nmoc_z,3))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n = 1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 1872, 2664, 2388, 2400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(1) = 1
                 tidx1(1:nchunks(1)) = (/2389/) ! 1000
                 tidx2(1:nchunks(1)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat4a)
                    !
                    cmordat3d = var_info(var_found(ifile,1))%missing_value
                    cmordat3d(:,:,2) = var_info(var_found(ifile,1))%missing_value ! Indo-Pacific not supplied
                    !
                    ! Convert from Sv to kg s-1
                    !
                    where (indat4a(:,:,1,2) /= 0.)
                       cmordat3d(:,:,1) = indat4a(:,:,1,2)*1.e6*1.e3
                    elsewhere
                       cmordat3d(:,:,1) = var_info(var_found(ifile,1))%missing_value
                    endwhere
                    where (indat4a(:,:,1,1) /= 0.)
                       cmordat3d(:,:,3) = indat4a(:,:,1,1)*1.e6*1.e3
                    elsewhere
                       cmordat3d(:,:,3) = var_info(var_found(ifile,1))%missing_value
                    endwhere
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat3d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 if (ic < nchunks(ifile)) then
                    cmor_filename(1:) = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                       stop
                    else
                       write(*,'(''GOOD close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                    endif
                 endif
              enddo
           enddo
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        case ('msftmyzba')
           !
           ! msftmyz: MOC
           !
           ! moc_comp(1)="Eulerian Mean" 
           ! moc_comp(2)="Eddy-Induced (bolus)" 
           ! moc_comp(3)="Submeso" 
           ! 
           ! transport_reg(1):="Global Ocean - Marginal Seas" 
           ! transport_reg(2):="Atlantic Ocean + Mediterranean Sea + Labrador Sea + GIN Sea + Arctic Ocean + Hudson Bay" 
           !
           ! MOC:coordinates = "lat_aux_grid moc_z moc_components transport_region time"
           !
           !                Y           Z      comp      basin
           allocate(indat4a(nlats_trans,nmoc_z,nmoc_comp,ntrans_reg))
           !
           ! basin 1: 'atlantic_arctic_ocean'
           ! basin 2: 'indian_pacific_ocean'
           ! basin 3: 'global_ocean'
           !
           !                  Y           Z      basin
           allocate(cmordat3d(nlats_trans,nmoc_z,3))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              !
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
              allocate(time(ntimes(ifile,1)))
              allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n = 1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              !
              select case (ntimes(ifile,1))
              case ( 1872, 2664, 2388, 2400 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) =  1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(1) = 1
                 tidx1(1:nchunks(1)) = (/2389/) ! 1000
                 tidx2(1:nchunks(1)) = (/6000/) ! 1300
              case ( 4824 ) ! LGM from 149901 to 190012; want only 1800-1900
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/3613/) ! 1800-01
                 tidx2(1:nchunks(ifile)) = (/4824/) ! 1900-12
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case ( 12000 ) ! BGC controls
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/1201,4201/)
                    tidx2(1:nchunks(ifile)) = (/4200,7200/)
                 endif
                 if (trim(case_read)=='b40.coup_carb.004') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
                 endif
              case ( 120 ) ! Decade, but may need to subset
                 if (trim(case_read)=='b40.prescribed_carb.001') then ! Use only 0101-0600
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0100') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0600') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 elseif (trim(case_read)=='b40.coup_carb.004') then ! Use only 0301-0800                  
                    call parse_ncfile(trim(ncfile(ifile,1)),fcase,fcomp,fsvar,ftime)
                    if (ftime(1:4) == '0300') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 13
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    elseif (ftime(1:4) == '0800') then
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = 12
                    else
                       nchunks(ifile) = 1
                       tidx1(1:nchunks(ifile)) = 1
                       tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                    endif
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case ( 60, 1152, 1140, 552, 600, 612 ) ! RCPs, skip 2005
                 if (exp(exp_found)%runbeg==2005) then
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 endif
              case default
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
              end select
              write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat4a)
                    !
                    cmordat3d = 1.e20
                    cmordat3d(:,:,2) = var_info(var_found(ifile,1))%missing_value ! Indo-Pacific not supplied
                    !
                    ! Convert from Sv to kg s-1
                    !
                    where (indat4a(:,:,2,2) /= 0.)
                       cmordat3d(:,:,1) = indat4a(:,:,2,2)*1.e6*1.e3
                    elsewhere
                       cmordat3d(:,:,1) = var_info(var_found(ifile,1))%missing_value
                    endwhere
                    where (indat4a(:,:,2,1) /= 0.)
                       cmordat3d(:,:,3) = indat4a(:,:,2,1)*1.e6*1.e3
                    elsewhere
                       cmordat3d(:,:,3) = var_info(var_found(ifile,1))%missing_value
                    endwhere
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat3d,   &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 if (ic < nchunks(ifile)) then
                    cmor_filename(1:) = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                       stop
                    else
                       write(*,'(''GOOD close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                    endif
                 endif
              enddo
           enddo
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
           endif
           do ifile = 1,nc_nfiles(1)
              call close_cdf(myncid(ifile,1))
           enddo
        end select
        if (allocated(indat2a))   deallocate(indat2a)
        if (allocated(indat2b))   deallocate(indat2b)
        if (allocated(indat2c))   deallocate(indat2c)
        if (allocated(indat4a))   deallocate(indat4a)
        if (allocated(cmordat2d)) deallocate(cmordat2d)
        if (allocated(indat3a))   deallocate(indat3a)
        if (allocated(indat3b))   deallocate(indat3b)
        !
        ! Reset
        !
        error_flag   = 0
        mycmor%positive = ' '
        original_name= ' '
        call reset_netcdf_var
     endif
  enddo xwalk_loop
end program Omon_CMOR
@


1.8
log
@*** empty log message ***
@
text
@d259 2
d314 1
a314 1
              'phyfe','phyn','phypico','phyp','physi','po4','si','talk','zooc',&
d2914 1
a2914 1
        case ('fddtdin','fddtdinrlds','fbddtdin')
@


1.7
log
@*** empty log message ***
@
text
@d234 1
a234 1
        case ('msftmyz','msftbarot','wmo','umo','vmo')
d285 1
a285 1
        case ('msftmyz')
d397 1
a397 1
              case ( 60, 1152 ) ! RCP, skip 2005
d537 1
a537 1
              case ( 60, 1152 ) ! RCP, skip 2005
d1258 1
a1258 1
              case ( 60, 1152 ) ! RCP, skip 2005
d1398 1
a1398 1
              case ( 60, 1152 ) ! RCP, skip 2005
d1546 1
a1546 1
              case ( 60 ) ! RCP, skip 2005
d1548 8
a1555 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a1556 9
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1669 1
a1669 1
              case ( 60 ) ! RCP, skip 2005
d1671 8
a1678 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a1679 9
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1836 1
a1836 1
              case ( 60 )               ! RCP from 2005-2009, skip 2005
d1838 8
a1845 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a1846 8
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
d2008 1
a2008 1
              case ( 60 )               ! RCP from 2005-2009, skip 2005
d2010 8
a2017 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a2018 8
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
d2179 1
a2179 1
              case ( 60 )               ! RCP from 2005-2009, skip 2005
d2181 8
a2188 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a2189 9
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2355 1
a2355 1
              case ( 60 )               ! RCP from 2005-2009, skip 2005
d2357 8
a2364 7
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
                 else
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 1
                    tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
a2365 8
              case ( 1152 )               ! RCP all in one file from 2005-2100
                 nchunks(ifile) = 10
                 tidx1(1) =  13
                 tidx2(1) =  60
                 do ic = 2,nchunks(ifile)
                    tidx1(ic) = tidx2(ic-1) + 1
                    tidx2(ic) = tidx1(ic) + 119
                 enddo
d2535 1
a2535 1
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
d2689 1
a2689 1
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
d2849 1
a2849 1
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
d4800 1
a4800 1
              case ( 1140, 1872, 2664, 2388, 2400 )
d4863 1
a4863 1
              case ( 60,1152 ) ! 2005 -> 2009 or 2100 of RCP, skip 2005
d4940 181
@


1.6
log
@*** empty log message ***
@
text
@d26 1
d28 1
a28 1
  real,dimension(:,:)  ,allocatable::indat2a,indat2b,indat2c,icefrac,cmordat2d,sum_dz
d39 1
d110 1
a110 1
           call build_filenames(case_read,comp_read,xw(ixw)%cesm_vars(ivar),ivar,exp(exp_found)%begyr,exp(exp_found)%endyr,mycmor%table_file)
d117 6
d135 2
a136 1
              call read_att_text(myncid(ifile,ivar),'time','units',time_units)
a147 2
              call close_cdf(myncid(ifile,ivar))
              !
d155 2
a156 1
        write(logfile,'(''log_cmor.'',a,''.'',a,''_'',a)') &
d238 2
d244 1
a244 1
        case ('fbddtalk','fddtalk','intpp')
d248 2
d259 1
a259 1
        case ('epc100','epcalc100','epfe100','epsi100','fgo2')
d309 1
a309 1
              'msftbarot','omlmax','pr','prsn','rlds','rsntds','sos','tauuo','tauvo','tos','tossq','zos',&
a343 1
           tcount = 1
a357 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d361 36
d398 1
a398 1
                 if (exp(exp_found)%begyr==2005) then
d401 1
a401 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d405 1
a405 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d425 1
a425 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d433 1
a433 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d435 2
a455 1
                    tcount = tcount + 1
d457 1
a457 1
                 write(*,'(''DONE writing '',a,'' T# '',2i8,'' chunk# '',i6)') trim(xw(ixw)%entry),tcount,it-1,ic
a460 1
              call close_cdf(myncid(ifile,1))
d472 3
d479 4
a482 3
           if (.not.(allocated(indat3a)))   allocate(indat3a(nlons,nlats,nlevs))
           if (.not.(allocated(cmordat2d))) allocate(cmordat2d(nlons,nlats))
           tcount = 1
a497 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d501 36
d538 1
a538 1
                 if (exp(exp_found)%begyr==2005) then
d541 1
a541 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d545 1
a545 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d565 1
a565 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d573 1
a573 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d575 1
d580 2
a581 1
                    indat3a = var_info(var_found(ifile,1))%missing_value
d583 7
a589 5
                    where (indat3a(:,:,1) /= var_info(var_found(ifile,1))%missing_value)
                       cmordat2d = 1000*indat3a(:,:,1)
                    elsewhere
                       cmordat2d = var_info(var_found(ifile,1))%missing_value
                    endwhere
a601 1
                    tcount = tcount + 1
d604 10
a616 17
              call close_cdf(myncid(ifile,1))
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
              if (exp(exp_found)%expt_id=='past1000') then
                 if (tcount==6001) then
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                       stop
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                    endif
                 endif
              endif
d624 3
d647 1
a647 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d651 36
d688 1
a688 1
                 if (exp(exp_found)%begyr==2005) then
d691 1
a691 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d695 1
a695 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d715 1
a715 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d723 1
a723 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d725 1
d730 2
a731 1
                    indat3a = var_info(var_found(ifile,1))%missing_value
d735 1
a735 1
                          if (indat3a(i,j,1) /= var_info(var_found(ifile,1))%missing_value) then
d753 1
a753 1
                 write(*,'(''DONE writing '',a,'' T# '',2i8,'' chunk# '',i6)') trim(xw(ixw)%entry),tcount,it-1,ic
a756 1
              call close_cdf(myncid(ifile,1))
d768 3
d791 1
a791 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d795 36
d832 1
a832 1
                 if (exp(exp_found)%begyr==2005) then
d835 1
a835 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d839 1
a839 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d859 1
a859 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d862 1
a862 1
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
d864 4
d871 1
a871 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d882 1
a882 1
                          if (indat2a(i,j) /= var_info(var_found(ifile,1))%missing_value) then
a901 1
              call close_cdf(myncid(ifile,1))
d909 3
d932 1
a932 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d936 36
d973 1
a973 1
                 if (exp(exp_found)%begyr==2005) then
d976 1
a976 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d980 1
a980 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1000 4
a1003 4
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
d1005 4
d1012 1
a1012 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1023 1
a1023 1
                          if (indat2a(i,j) /= var_info(var_found(ifile,1))%missing_value) then
a1042 1
              call close_cdf(myncid(ifile,1))
d1050 3
d1073 1
a1073 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1077 36
d1114 1
a1114 1
                 if (exp(exp_found)%begyr==2005) then
d1117 1
a1117 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1121 1
a1121 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1129 1
d1142 4
a1145 4
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
d1147 4
d1154 1
a1154 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1165 1
a1165 1
                          if (indat2a(i,j) /= var_info(var_found(ifile,1))%missing_value) then
a1184 1
              call close_cdf(myncid(ifile,1))
d1192 3
d1196 1
a1196 1
              'fbddtdic','fbddtdife','fbddtdip','fbddtdisi',&
d1218 1
a1218 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1222 36
d1259 1
a1259 1
                 if (exp(exp_found)%begyr==2005) then
d1262 1
a1262 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1266 1
a1266 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1286 4
a1289 4
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
                    nchunks(ifile)= 2
                    tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                    tidx2(1:nchunks(ifile)) = (/6000,12012/)
d1294 1
a1294 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1317 10
a1327 1
              call close_cdf(myncid(ifile,1))
d1335 3
d1342 2
a1343 1
           if (.not.(allocated(indat2a))) allocate(indat2a(nlons,nlats))
a1358 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1362 36
d1399 1
a1399 1
                 if (exp(exp_found)%begyr==2005) then
d1402 1
a1402 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1406 1
a1406 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1426 1
a1426 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d1434 1
a1434 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1436 1
d1443 7
a1449 3
                    where (indat2a /= var_info(var_found(ifile,1))%missing_value)
                       indat2a = indat2a * (1.e6 * 1000.) ! 10^6 m3 s-1 to kg s-1
                    endwhere
a1470 1
              call close_cdf(myncid(ifile,1))
d1484 3
a1506 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1510 36
d1547 1
a1547 1
                 if (exp(exp_found)%begyr==2005) then
d1550 1
a1550 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1554 1
a1554 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1564 1
d1573 1
d1582 1
a1582 1
              case ( 300 ) ! 30 years
d1585 5
a1589 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d1591 1
a1591 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d1603 1
a1605 2
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
a1636 1
              call close_cdf(myncid(ifile,1))
d1650 3
d1673 1
a1673 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1678 1
a1678 1
                 if (exp(exp_found)%begyr==2005) then
d1695 1
d1704 1
d1713 1
a1713 1
              case ( 300 ) ! 25 years
d1716 5
a1720 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d1722 1
a1722 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d1734 1
a1735 3
              !
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
d1743 9
a1751 3
                    where (indat3a /= var_info(var_found(ifile,1))%missing_value)
                       indat3a = indat3a/1.e12
                    endwhere
a1775 1
              call close_cdf(myncid(ifile,1))
d1789 3
d1812 1
a1812 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1816 36
d1853 1
a1853 1
                 if (exp(exp_found)%begyr==2005) then
d1878 1
d1887 2
a1888 1
              case ( 300 ) ! 30 years
d1891 5
a1895 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d1897 1
a1897 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d1909 1
a1910 3
              !
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
a1954 1
              call close_cdf(myncid(ifile,1))
d1968 3
d1991 1
a1991 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d1995 36
d2032 1
a2032 1
                 if (exp(exp_found)%begyr==2005) then
d2057 1
d2066 5
a2070 1
              case ( 300 ) ! 30 years
d2073 1
a2073 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d2075 1
a2075 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d2087 1
a2088 3
              !
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
a2132 1
              call close_cdf(myncid(ifile,1))
d2146 3
d2169 1
a2169 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2173 36
d2210 1
a2210 1
                 if (exp(exp_found)%begyr==2005) then
d2213 1
a2213 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2217 1
a2217 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2227 1
d2236 1
d2245 5
a2249 1
              case ( 300 ) ! 30 years
d2252 1
a2252 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d2254 1
a2254 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d2266 1
a2267 3
              !
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
a2316 1
              call close_cdf(myncid(ifile,1))
d2330 3
d2353 1
a2353 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2357 36
d2394 1
a2394 1
                 if (exp(exp_found)%begyr==2005) then
d2397 1
a2397 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2401 1
a2401 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2419 1
d2428 5
a2432 1
              case ( 300 ) ! 15 years
d2435 1
a2435 1
                 tidx2(1:nchunks(ifile)) = (/120, 240, 300/)
d2437 1
a2437 1
                 if ((exp(exp_found)%begyr==2006).and.(exp(exp_found)%endyr==2035)) then
d2449 1
a2450 2
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
              !
d2459 1
a2459 1
                       indat3a = indat3a*1000.
a2484 1
              call close_cdf(myncid(ifile,1))
d2498 3
d2540 1
a2540 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2544 36
d2581 1
a2581 1
                 if (exp(exp_found)%begyr==2005) then
d2584 1
a2584 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2588 1
a2588 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2608 1
a2608 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d2615 2
a2616 2
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
a2618 1
              !
d2622 1
a2622 1
                    write(*,'(''TIME: '',i10,10x,f10.3)') it,time(it)
a2634 1
              call close_cdf(myncid(ifile,1))
d2642 1
a2642 1
                 indat1a = 1.e6*(indat1a/sum(volume))
d2644 1
a2644 1
!              write(*,*) 'MIN: ',minval(indat1a),'MAX: ',maxval(indat1a)
d2671 3
d2694 1
a2694 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2698 36
d2735 1
a2735 1
                 if (exp(exp_found)%begyr==2005) then
d2738 1
a2738 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2742 1
a2742 1
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2762 1
a2762 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d2769 2
a2770 2
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2778 1
a2778 2
                    indat3a = 1.e30
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat1a)
d2781 1
a2781 4
              call close_cdf(myncid(ifile,1))
              !
              write(*,*) 'MIN: ',minval(indat1a),'MAX: ',maxval(indat1a)
              !
a2792 1
              if (allocated(indat1a))   deallocate(indat1a)
d2806 3
d2836 1
a2836 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2839 36
d2889 1
a2889 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d2894 10
d2907 1
a2907 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2909 1
d2952 6
a2957 1
        case ('fddtdin','fddtdinrlds')
d2981 1
a2981 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d2988 4
d3002 1
a3002 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d3007 10
d3031 1
a3031 5
                          if ((indat2a(i,j) /= spval).and.(indat2b(i,j) /= spval)) then
                             cmordat2d(i,j) = indat2a(i,j) + indat2b(i,j)
                          else
                             cmordat2d(i,j) = spval
                          endif
d3057 4
d3088 1
a3088 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d3105 1
a3105 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d3110 46
d3159 1
a3159 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d3161 1
d3172 1
a3172 5
                          if ((indat3a(i,j,1) /= spval).and.(indat3b(i,j,1) /= spval).and.(indat3c(i,j,1) /= spval)) then
                             cmordat2d(i,j) = indat3a(i,j,1) + indat3b(i,j,1) + indat3c(i,j,1)
                          else
                             cmordat2d(i,j) = spval
                          endif
d3199 6
a3204 1
        case ('epc100','epcalc100','epfe100','epsi100')
d3206 2
a3207 3
           ! Full-column fields, but use only "depth100m" meters; z_t at index 11 - 
           ! "Please sample those fields at 105m. In the model output, these fields are actually 
           ! fluxes into the top of the cell, and the top of the cell whose center is at 105m is at 100m."
d3209 1
a3209 1
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
d3214 6
d3232 1
a3232 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d3249 1
a3249 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d3254 46
d3303 1
a3303 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d3305 1
d3312 2
d3316 3
a3318 4
                          if (indat3a(i,j,11) /= spval) then
                             cmordat2d(i,j) = indat3a(i,j,11)
                          else
                             cmordat2d(i,j) = spval
a3338 1
           cmor_filename = ' '
d3346 6
a3351 1
        case ('intdic')
d3353 2
a3354 2
           ! Single full-column fields, integrate over all of z_t
           ! and convert from mmol/m3 to kg m-2 via *12.0e-8
d3356 1
a3356 1
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats),sum_dz(nlons,nlats))
d3361 6
d3379 1
a3379 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d3396 1
a3396 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d3401 50
d3454 1
a3454 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d3456 1
d3461 1
a3461 1
                    cmordat2d = 0. ; sum_dz = 0.
d3463 867
a4329 1
                    do k = 1,nlevs
d4333 1
a4333 4
!                                sum_dz(i,j) = sum_dz(i,j) + ocn_t_dz(k)
                                cmordat2d(i,j) = (indat3a(i,j,k)*ocn_t_dz(k))*12.0e-8
                             else
                                cmordat2d(i,j) = spval
d4338 7
a4344 9
!!$                    do j = 1,nlats
!!$                       do i = 1,nlons
!!$                          if (cmordat2d(i,j) /= spval) then
!!$                             cmordat2d(i,j) = cmordat2d(i,j) / sum_dz(i,j)
!!$                          else
!!$                             cmordat2d(i,j) = spval
!!$                          endif
!!$                       enddo
!!$                    enddo
d4370 8
a4377 1
        case ('intpp')
d4379 4
a4382 1
           ! Add three 15-level fields, integrate over z_t_150m, multiply by 1.e-5 to convert units
a4383 1
           allocate(indat3a(nlons,nlats,15),indat3b(nlons,nlats,15),indat3c(nlons,nlats,15),cmordat2d(nlons,nlats))
a4387 6
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
              call open_cdf(myncid(ifile,3),trim(ncfile(ifile,3)),.true.)
              call get_dims(myncid(ifile,3))
              call get_vars(myncid(ifile,3))
d4400 1
a4400 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d4417 1
a4417 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d4422 46
d4471 1
a4471 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d4473 1
d4477 11
d4489 130
a4618 1
                    cmordat2d = 0. ; sum_dz = 0.
a4619 2
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    call read_var(myncid(ifile,3),var_info(var_found(ifile,3))%name,indat3c)
d4624 1
a4624 6
!                                sum_dz(i,j) = sum_dz(i,j) + ocn_t_dz(k)
                                cmordat2d(i,j) = (((indat3a(i,j,k)*ocn_t_dz(k))+&
                                                   (indat3b(i,j,k)*ocn_t_dz(k))+&
                                                   (indat3c(i,j,k)*ocn_t_dz(k))))*1.e-5
                             else
                                cmordat2d(i,j) = spval
a4628 9
!!$                    do j = 1,nlats
!!$                       do i = 1,nlons
!!$                          if (cmordat2d(i,j) /= spval) then
!!$                             cmordat2d(i,j) = cmordat2d(i,j) / sum_dz(i,j)
!!$                          else
!!$                             cmordat2d(i,j) = spval
!!$                          endif
!!$                       enddo
!!$                    enddo
d4654 3
d4684 1
a4684 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
d4687 4
d4705 1
a4705 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d4710 46
d4759 1
a4759 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d4761 1
d4799 5
d4841 1
a4841 1
!              time_bnds(1,1) = int(time_bnds(1,1))-1
a4856 4
              case ( 1152 )
                 nchunks(ifile)= 1
                 tidx1(1:nchunks(ifile)) = 13
                 tidx2(1:nchunks(ifile)) = ntimes(ifile,1)
d4867 1
a4867 1
                 if (trim(case_read)=='b40.coup_carb.001') then       ! Use only 0301-0800
d4872 46
d4923 1
a4923 1
              !
d4982 3
a4992 2
        if (allocated(work3da))   deallocate(work3da)
        if (allocated(work3db))   deallocate(work3db)
@


1.5
log
@*** empty log message ***
@
text
@d234 11
d247 2
d324 3
a326 2
        case ('chldiat','chldiaz','chlpico','co3','co3satarag','co3satcalc','dfe','tos',&
              'dissic','dissoc','nh4','no3','o2','phycalc','phydiat','phydiaz','phypico','physi','po4','si','zooc')
d347 1
a347 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d365 4
d373 11
d431 419
a849 2
           if (.not.(allocated(cmordat2d))) allocate(cmordat2d(nlons,nlats))
           tcount = 1
d860 1
a860 1
              do n = 1,ntimes(ifile,1)
d865 1
a865 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d883 4
d891 11
d907 1
d912 9
a920 7
                    indat3a = var_info(var_found(ifile,1))%missing_value
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    where (indat3a(:,:,1) /= var_info(var_found(ifile,1))%missing_value)
                       cmordat2d = 1000*indat3a(:,:,1)
                    elsewhere
                       cmordat2d = var_info(var_found(ifile,1))%missing_value
                    endwhere
d925 1
a925 1
                         data          = cmordat2d,   &
a932 1
                    tcount = tcount + 1
d934 1
a934 1
                 write(*,'(''DONE writing '',a,'' T# '',2i8,'' chunk# '',i6)') trim(xw(ixw)%entry),tcount-1,it-1,ic
a935 2
              if (allocated(time))      deallocate(time)
              if (allocated(time_bnds)) deallocate(time_bnds)
a936 16
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
              if (exp(exp_found)%expt_id=='past1000') then
                 if (tcount==6001) then
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                       stop
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                    endif
                 endif
              endif
d945 3
a947 3
              'dpco2','fbddtalk','fbddtdic','fbddtdife','fbddtdip','fbddtdisi',&
              'fddtalk','fddtdic','fddtdife','fddtdip','fddtdisi','fgco2','fgo2',&
              'o2min','zo2min','spco2','zsatarag','zsatcalc')
d967 1
a967 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d985 4
d993 11
a1029 6
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                 else
                    write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
                 endif
a1030 6
              error_flag = cmor_close()
              if (error_flag < 0) then
                 write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
              else
                 write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') trim(xw(ixw)%entry),error_flag
              endif
d1033 6
a1038 4
           dim_counter  = 0
           var_counter  = 0
           time_counter = 0
           file_counter = 0
d1059 1
a1059 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1077 4
d1085 11
d1165 1
a1165 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1281 2
a1282 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1289 1
a1289 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1408 2
a1409 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1416 1
a1416 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1545 2
a1546 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1553 1
a1553 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1682 2
a1683 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1690 1
a1690 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1824 2
a1825 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1832 1
a1832 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1968 2
a1969 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d1977 1
a1977 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d1991 4
d2003 11
d2024 1
d2085 2
a2086 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2094 1
a2094 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2108 4
d2120 11
d2194 2
a2195 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2202 1
a2202 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2213 11
d2271 1
a2271 1
        case ('fbddtdin','fddtdinrlds')
d2287 2
a2288 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2295 1
a2295 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2306 11
d2320 1
a2320 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d2322 1
a2325 1
                    !
d2329 9
a2337 5
                    where ((indat2a /= spval).and.(indat2b /= spval))
                       cmordat2d = indat2a + indat2b
                    elsewhere
                       cmordat2d = spval
                    endwhere
a2351 9
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
d2354 7
d2380 2
a2381 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2388 1
a2388 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2399 11
a2446 10
              !
              cmor_filename = ' '
!              error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
              error_flag = cmor_close()
              if (error_flag < 0) then
                 write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                 stop
              else
                 write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
              endif
d2448 8
d2471 2
a2472 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2479 1
a2479 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2490 11
a2534 9
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
d2537 10
a2546 1
        case ('intdic','ph','talk')
d2549 1
d2560 2
a2561 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2568 1
a2568 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2579 11
d2605 2
a2606 2
                                cmordat2d(i,j) = indat3a(i,j,k)*ocn_t_levs(k)
                                sum_dz(i,j) = sum_dz(i,j) + ocn_t_levs(k)
d2613 108
a2720 7
                    do j = 1,nlats
                       do i = 1,nlons
                          if (cmordat2d(i,j) /= spval) then
                             cmordat2d(i,j) = cmordat2d(i,j) / sum_dz(i,j)
                          else
                             cmordat2d(i,j) = spval
                          endif
d2723 9
a2744 10
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
d2746 1
d2748 9
d2776 2
a2777 2
              allocate(time(ntimes(1,1)))
              allocate(time_bnds(2,ntimes(1,1)))
d2784 1
a2784 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2795 11
a2838 10
              !
              cmor_filename = ' '
!                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
              error_flag = cmor_close()
              if (error_flag < 0) then
                 write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                 stop
              else
                 write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
              endif
d2840 8
d2885 1
a2885 1
              time_bnds(1,1) = int(time_bnds(1,1))-1
d2897 4
d2909 11
@


1.4
log
@*** empty log message ***
@
text
@d311 2
a312 1
        case ('tos')
d314 1
a314 1
           ! tos: TEMP at k=1
d338 9
a346 3
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
a389 12
              if (exp(exp_found)%expt_id=='past1000') then
                 if (tcount==6001) then
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                       stop
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                    endif
                 endif
              endif
d424 9
a432 3
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d527 9
a535 3
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d614 9
a622 3
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d705 9
a713 2
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
d814 4
a817 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d829 9
a837 2
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = 1
d941 4
a944 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d956 9
a964 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1078 4
a1081 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d1093 9
a1101 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1215 4
a1218 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d1230 9
a1238 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1357 4
a1360 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d1372 9
a1380 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1500 6
a1505 3
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
              if (.not.(allocated(indat1a)))   allocate(indat1a(ntimes(ifile,1)))
d1517 9
a1525 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1601 6
a1606 3
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
              if (.not.(allocated(indat1a)))   allocate(indat1a(ntimes(ifile,1)))
d1618 9
a1626 3
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d1696 4
a1699 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d1778 4
a1781 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d1858 4
a1861 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
a1914 9
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
d1916 10
d1940 4
a1943 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
a2005 76
        case ('chldiat','chldiaz','chlpico','co3','co3satarag','co3satcalc','dfe',&
              'dissic','dissoc','nh4','no3','o2','phycalc','phydiat','phydiaz','phypico','physi','po4','si','zooc')
           !
           ! Full-column fields, but use only "depth0m" meters; z_t at index 1
           !
           allocate(indat3a(nlons,nlats,nlevs),cmordat2d(nlons,nlats))
           do ifile = 1,nc_nfiles(1)
              call open_cdf(myncid(ifile,1),trim(ncfile(ifile,1)),.true.)
              call get_dims(myncid(ifile,1))
              call get_vars(myncid(ifile,1))
              spval=var_info(var_found(1,1))%missing_value
              !
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
              !
              do n=1,ntimes(ifile,1)
                 time_counter = n
                 call read_var(myncid(ifile,1),'time_bound',time_bnds(:,n))
              enddo
              !
              time_bnds(1,1) = int(time_bnds(1,1))-1
              time = (time_bnds(1,:)+time_bnds(2,:))/2.
              select case (ntimes(ifile,1))
              case ( 6192 ) ! midHolocene from 080101-131612; want only 1000-1300
                 nchunks(ifile) = 1
                 tidx1(1:nchunks(ifile)) = (/2389/) ! 1000
                 tidx2(1:nchunks(ifile)) = (/6000/) ! 1300
              case ( 12012 )
                 nchunks(ifile)= 2
                 tidx1(1:nchunks(ifile)) = (/   1, 6001/)
                 tidx2(1:nchunks(ifile)) = (/6000,12012/)
              case default
                 nchunks(ifile)   = 1
                 tidx1(1:nchunks(ifile)) = 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
              end select
              do ic = 1,nchunks(ifile)
                 do it = tidx1(ic),tidx2(ic)
                    time_counter = it
                    !
                    cmordat2d = spval
                    call read_var(myncid(ifile,1),var_info(var_found(ifile,1))%name,indat3a)
                    do j = 1,nlats
                       do i = 1,nlons
                          if (indat3a(i,j,1) /= spval) then
                             cmordat2d(i,j) = indat3a(i,j,1)
                          else
                             cmordat2d(i,j) = spval
                          endif
                       enddo
                    enddo
                    !
                    tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                    error_flag = cmor_write(          &
                         var_id        = cmor_var_id, &
                         data          = cmordat2d,     &
                         ntimes_passed = 1,           &
                         time_vals     = tval,        &
                         time_bnds     = tbnd)
                    if (error_flag < 0) then
                       write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                       stop
                    endif
                 enddo
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
              enddo
           enddo
d2017 4
a2020 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d2112 4
a2115 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
a2164 9
                 !
                 cmor_filename = ' '
                 error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                 if (error_flag < 0) then
                    write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                    stop
                 else
                    write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                 endif
d2166 10
@


1.3
log
@*** empty log message ***
@
text
@d27 1
a27 1
  real,dimension(:,:)  ,allocatable::indat2a,indat2b,indat2c,icefrac,cmordat2d
d282 8
a289 7
        case ('dpco2','dpo2','evs','fgco2','fgdms','fgo2','ficeberg2d','frc','frfe','friver','frn','fsc','fsfe','fsitherm','fsn',&
              'hfcorr','hfds','hfevapds','hfgeou','hfibthermds2d','hfls','hfnorthba','hfnorthdiff','hfnorth','hfrainds','hfrunoffds2d',&
              'hfsifrazil2d','hfsithermds2d','hfsnthermds2d','hfss','hfxba','hfxdiff','hfx','hfyba','hfydiff','hfy','intdic',&
              'intparag','intpbfe','intpbsi','intpcalcite','intpcalc','intpdiat','intpdiaz','intpmisc','intpn2','intpnitrate',&
              'intppico','intpp','mlotst','mlotstsq','msftbarot','o2min','omldamax','omlmax','pbo','pr','prsn','pso',&
              'rlds','rsntds','sfdsi','sfriver','sos','spco2','tauucorr','tauuo','tauvcorr','tauvo','tos','tossq','vsfcorr',&
              'vsfevap','vsf','vsfpr','vsfriver','vsfsit','wfcorr','wfonocorr','wfo','zo2min','zos','zossq','zsatarag','zsatcalc')
d498 4
a501 1
        case ('tauuo','tauvo','hfss','pr','prsn','rsds','rsntds','zos','omlmax')
d503 1
a503 1
           ! tauuo,tauvo,hfss,pr,prsn,rsds,rsntds: No changes
d1683 477
@


1.2
log
@*** empty log message ***
@
text
@d21 2
d27 1
a27 1
  real,dimension(:,:)  ,allocatable::indat2a,indat2b,indat2c,cmordat2d
d96 1
a96 1
     if (xw(ixw)%ncesm_vars == 0) then
d102 1
a102 1
        if (trim(xw(ixw)%cesm_vars(ivar)) == 'UNKNOWN') then
d130 1
a130 1
                 if (trim(var_info(n)%name) == trim(xw(ixw)%cesm_vars(ivar))) then
d135 1
a135 1
              if (var_found(ifile,ivar) == 0) then
d213 1
a213 1
        if (xw(ixw)%ncesm_vars == 1) then
d216 1
a216 1
        if (xw(ixw)%ncesm_vars == 2) then
d219 1
a219 1
        if (xw(ixw)%ncesm_vars == 3) then
d226 1
a226 1
        case ('msftmyz','msftbarot','wmo','wmosq','umo','vmo')
d228 2
d322 4
a325 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
a330 1
              !
d337 10
a346 1
                 tidx1(1:nchunks(ifile)) = 13
d350 1
a351 1
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
d382 2
a383 2
              if (exp(exp_found)%expt_id == 'past1000') then
                 if (tcount == 6001) then
d397 1
a397 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d399 1
a399 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d413 4
a416 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d429 10
a438 1
                 tidx1(1:nchunks(ifile)) = 13
d442 1
a443 1
              tidx2(nchunks(ifile)) = ntimes(ifile,1)
d478 2
a479 2
              if (exp(exp_found)%expt_id == 'past1000') then
                 if (tcount == 6001) then
d493 1
a493 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d495 1
a495 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d497 1
a497 1
        case ('tauuo','tauvo','hfss','pr','prsn','rsds','rsntds','zos')
d502 34
a535 25
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                 enddo
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,1))
                 case ( 60, 1152 ) ! RCP, skip 2005
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
d537 20
a556 20
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat2a = var_info(var_found(ifile,1))%missing_value
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat2a)
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = indat2a,     &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d558 7
a564 3
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
d566 7
a572 4
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
d574 4
a577 6
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           endif
d583 34
a616 25
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                 enddo
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,1))
                 case ( 60, 1152 ) ! RCP, skip 2005
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
d618 10
a627 109
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat2a = var_info(var_found(ifile,1))%missing_value
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat2a)
                       where (indat2a /= var_info(var_found(ifile,1))%missing_value)
                          indat2a = indat2a * (1.e6 * 1000.) ! 10^6 m3 s-1 to kg s-1
                       endwhere
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = indat2a,     &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                 enddo
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
              enddo
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           endif
        case ('thetao','agessc','uo','vo','rhopoto')
           !
           ! No changes
           !
           allocate(indat3a(nlons,nlats,nlevs))
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                 enddo
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,ivar))
                 case ( 60 ) ! RCP, skip 2005
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                 case ( 1152 )               ! RCP all in one file from 2005-2100
                    nchunks(ifile) = 10
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                 case ( 1872 ) ! 20C from 1850-2005
                    nchunks(ifile) = 16
                    tidx1(1) =   1
                    tidx2(1) = 120
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
                 !
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
                 !
                 write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat3a = var_info(var_found(ifile,1))%missing_value
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat3a)
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = indat3a,     &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d629 7
a635 2
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
d637 1
a637 1
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
a638 2
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
d641 7
a647 3
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
d649 3
d659 1
a659 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d661 1
a661 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d663 1
a663 1
        case ('cfc11')
d665 1
a665 1
           ! cfc11 - convert fmol/cm^3 to mol kg-1
a667 99
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                 enddo
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,ivar))
                 case ( 60 ) ! RCP, skip 2005
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                 case ( 1152 )               ! RCP all in one file from 2005-2100
                    nchunks(ifile) = 10
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                 case ( 1872 ) ! 20C from 1850-2005
                    nchunks(ifile) = 16
                    tidx1(1) =   1
                    tidx2(1) = 120
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
                    enddo
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
                 !
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
                 !
                 write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat3a = var_info(var_found(ifile,1))%missing_value
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat3a)
                       where (indat3a /= var_info(var_found(ifile,1))%missing_value)
                          indat3a = indat3a/1.e12
                       endwhere
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = indat3a,     &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                    !
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                       stop
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                    endif
                 enddo
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
              enddo
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
           enddo
           error_flag = cmor_close()
           if (error_flag < 0) then
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           else
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
           endif
        case ('wmo','wmosq')
           !
           ! wmo,wmosq: Multiply WVEL (WVEL2) by PD and TAREA to get vertical mass transport
           !
           allocate(indat3a(nlons,nlats,nlevs),indat3b(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
!           write(*,'(''wmo allocate: '',3i5)') nlons,nlats,nlevs
a669 3
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
!              write(*,'(''wmo open_cdf :'',i6,5x,a)') myncid(ifile,1),trim(ncfile(ifile,1))
!              write(*,'(''wmo open_cdf :'',i6,5x,a)') myncid(ifile,2),trim(ncfile(ifile,2))
a671 2
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
d673 4
a676 2
              if (.not.(allocated(time)))      allocate(time(ntimes(ifile,1)))
              if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,1)))
d687 3
a689 4
              case ( 60 )               ! RCP from 2005-2009, skip 2005
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 13
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d706 22
d740 1
a740 3
                    indat3a   = var_info(var_found(ifile,1))%missing_value
                    indat3b   = var_info(var_found(ifile,2))%missing_value
                    cmordat3d = var_info(var_found(ifile,1))%missing_value
a741 14
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
!                    write(*,'(''read_var :'',i6,5x,a,5x)') myncid(ifile,1),var_info(var_found(ifile,1))%name
!                    write(*,'(''read_var :'',i6,5x,a,5x)') myncid(ifile,2),var_info(var_found(ifile,2))%name
                    do k = 1,nlevs
                       do j = 1,nlats
                          do i = 1,nlons
                             if (indat3a(i,j,k) /= var_info(var_found(ifile,1))%missing_value) then
                                cmordat3d(i,j,k) = (indat3a(i,j,k)*indat3b(i,j,k)*ocn_t_area(i,j))/1000. ! g s-1 to kg s-1
                             else
                                cmordat3d(i,j,k) = var_info(var_found(ifile,1))%missing_value
                             endif
                          enddo
                       enddo
                    enddo
a742 1
!                    write(*,'(''calculated at T: '',i6,5x,a,5x)') time_counter
d746 1
a746 1
                         data          = cmordat3d,   &
a766 1
              call close_cdf(myncid(ifile,2))
a768 4
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
d770 4
d776 1
a776 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d778 1
a778 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d780 1
a780 1
        case ('umo')
d782 1
a782 1
           ! umo: Multiply UVEL by PD and HUW to get ocean X mass transport
d784 1
a784 1
           allocate(indat3a(nlons,nlats,nlevs),indat3b(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
a786 1
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
a788 2
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
d802 3
a804 4
              case ( 60 )               ! RCP from 2005-2009, skip 2005
                 nchunks(ifile)   = 1
                 tidx1(nchunks(ifile)) = 13
                 tidx2(nchunks(ifile)) = ntimes(ifile,1)
d821 141
a974 1
                    indat3b   = var_info(var_found(ifile,2))%missing_value
d977 1
a977 2
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
                    do k = 1,nlevs
d981 1
a981 1
                                cmordat3d(i,j,k) = (indat3a(i,j,k)*indat3b(i,j,k)*ocn_u_huw(i,j)*ocn_t_dz(k))/1000. ! g s-1 to kg s-1
d988 1
a1013 1
              call close_cdf(myncid(ifile,2))
d1023 1
a1023 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1025 1
a1025 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1027 1
a1027 1
        case ('vmo')
d1029 1
a1029 1
           ! vmo: Multiply VVEL by PD and HUS to get ocean Y mass transport
d1031 1
a1031 1
           allocate(indat3a(nlons,nlats,nlevs),indat3b(nlons,nlats,nlevs),cmordat3d(nlons,nlats,nlevs))
a1033 1
              call open_cdf(myncid(ifile,2),trim(ncfile(ifile,2)),.true.)
a1035 2
              call get_dims(myncid(ifile,2))
              call get_vars(myncid(ifile,2))
d1051 1
a1051 1
                 tidx1(nchunks(ifile)) = 13
d1069 22
a1103 1
                    indat3b   = var_info(var_found(ifile,2))%missing_value
a1105 1
                    call read_var(myncid(ifile,2),var_info(var_found(ifile,2))%name,indat3b)
d1107 1
a1107 1
                       do j = 1,nlats
d1110 1
a1110 1
                                cmordat3d(i,j,k) = (indat3a(i,j,k)*indat3b(i,j,k)*ocn_u_hus(i,j)*ocn_t_dz(k))/1000. ! g s-1 to kg s-1
d1117 1
a1142 1
              call close_cdf(myncid(ifile,2))
d1152 1
a1152 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1154 1
a1154 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1156 1
a1156 1
        case ('so')
d1158 1
a1158 1
           ! so: SALT*1000 to handle CMOR change to psu bug
d1160 45
a1204 13
           allocate(indat3a(nlons,nlats,nlevs))
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
d1206 39
a1244 16
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,ivar))
                 case ( 60 )               ! RCP from 2005-2009, skip 2005
                    nchunks(ifile)   = 1
                    tidx1(nchunks(ifile)) = 13
                    tidx2(nchunks(ifile)) = ntimes(ifile,1)
                 case ( 1152 )               ! RCP all in one file from 2005-2100
                    nchunks(ifile) = 10
                    tidx1(1) =  13
                    tidx2(1) =  60
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
d1246 5
a1250 7
                 case ( 1872 ) ! 20C from 1850-2005
                    nchunks(ifile) = 16
                    tidx1(1) =   1
                    tidx2(1) = 120
                    do ic = 2,nchunks(ifile)
                       tidx1(ic) = tidx2(ic-1) + 1
                       tidx2(ic) = tidx1(ic) + 119
a1251 30
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
                 !
                 write(*,'(''# chunks '',i3,'':'',10((i4,''-'',i4),'',''))') nchunks(ifile),(tidx1(ic),tidx2(ic),ic=1,nchunks(ifile))
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat3a = var_info(var_found(ifile,1))%missing_value
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat3a)
                       where (indat3a /= var_info(var_found(ifile,1))%missing_value)
                          indat3a = indat3a*1000.
                       endwhere
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = indat3a,     &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d1253 7
a1259 2
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
d1261 1
a1261 1
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
a1262 2
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
d1265 10
a1274 3
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
d1276 3
d1286 119
a1404 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1406 1
a1406 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1450 1
a1450 1
                 tidx1(nchunks(ifile)) = 13
d1452 8
d1485 1
a1485 1
              if (xw(ixw)%entry == 'masso') then
d1487 1
a1487 1
              elseif (xw(ixw)%entry == 'thetaoga') then
d1489 1
a1489 1
              elseif (xw(ixw)%entry == 'soga') then
d1515 1
a1515 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1517 1
a1517 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1542 1
a1542 1
                 tidx1(nchunks(ifile)) = 13
d1544 8
d1592 1
a1592 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1594 1
a1594 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1596 83
a1678 60
!!$        case ('rlds')
!!$              !
!!$              ! rlds: LWUP_F - LWDN_F
!!$              !
!!$              allocate(indat2a(nlons,nlats),indat2b(nlons,nlats),cmordat2d(nlons,nlats))
!!$              do ivar = 1,xw(ixw)%ncesm_vars
!!$                 do ifile = 1,nc_nfiles(ivar)
!!$                    call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
!!$                    call get_dims(myncid(ifile,ivar))
!!$                    call get_vars(myncid(ifile,ivar))
!!$                    !
!!$                    if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
!!$                    if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
!!$                    !
!!$                    do n=1,ntimes(ifile,ivar)
!!$                       time_counter = n
!!$                       call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
!!$                    enddo
!!$                    !
!!$                    time_bnds(1,1) = int(time_bnds(1,1))-1
!!$                    time = (time_bnds(1,:)+time_bnds(2,:))/2.
!!$                    write(*,*) 'thetao loop: ',ifile,nc_nfiles(ivar),ntimes(ifile,ivar),nlons,nlats,nlevs
!!$                    nchunks(ifile)   = 1
!!$                    tidx1(1:nchunks(ifile)) = 1
!!$                    tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
!!$                    do ic = 1,nchunks(ifile)
!!$                       do it = tidx1(ic),tidx2(ic)
!!$                          time_counter = it
!!$                          !
!!$                          indat3a = spval
!!$                          call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat3a)
!!$                          !
!!$                          tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
!!$                          error_flag = cmor_write(          &
!!$                               var_id        = cmor_var_id, &
!!$                               data          = indat3a,     &
!!$                               ntimes_passed = 1,           &
!!$                               time_vals     = tval,        &
!!$                               time_bnds     = tbnd)
!!$                          if (error_flag < 0) then
!!$                             write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
!!$                             stop
!!$                          endif
!!$                       enddo
!!$                       write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
!!$                       !
!!$                       cmor_filename = ' '
!!$                       error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
!!$                       if (error_flag < 0) then
!!$                          write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
!!$                          stop
!!$                       else
!!$                          write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
!!$                       endif
!!$                    enddo
!!$                    call close_cdf(myncid(ifile,ivar))
!!$                    if (allocated(time))      deallocate(time)
!!$                    if (allocated(time_bnds)) deallocate(time_bnds)
!!$                 enddo
!!$              enddo
d1701 74
a1774 13
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 write(*,*) 'tbnds loop: ',ivar,ifile,myncid(ifile,ivar)
                 do n = 1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
d1776 1
d1778 8
a1785 58
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,ivar))
                 case ( 1140, 1872, 2388, 2400 )
                    nchunks(ifile)= 1
                    tidx1(1:nchunks(ifile)) =  1
                 case ( 1152 )
                    nchunks(ifile)= 1
                    tidx1(1:nchunks(ifile)) = 13
                 end select
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
                 !
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat4a)
                       !
                       cmordat3d = var_info(var_found(ifile,1))%missing_value
                       cmordat3d(:,:,2) = var_info(var_found(ifile,1))%missing_value ! Indo-Pacific not supplied
                       !
                       ! Convert from Sv to kg s-1
                       !
                       where (indat4a(:,:,1,2) /= 0.)
                          cmordat3d(:,:,1) = indat4a(:,:,1,2)*1.e6*1.e3
                       elsewhere
                          cmordat3d(:,:,1) = var_info(var_found(ifile,1))%missing_value
                       endwhere
                       where (indat4a(:,:,1,1) /= 0.)
                          cmordat3d(:,:,3) = indat4a(:,:,1,1)*1.e6*1.e3
                       elsewhere
                          cmordat3d(:,:,3) = var_info(var_found(ifile,1))%missing_value
                       endwhere
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = cmordat3d,   &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
                    !
                    if (ic < nchunks(ifile)) then
                       cmor_filename(1:) = ' '
                       error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                       if (error_flag < 0) then
                          write(*,'(''ERROR close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                          stop
                       else
                          write(*,'(''GOOD close chunk: '',i6,'' of '',a)') ic,cmor_filename(1:128)
                       endif
d1787 1
a1787 1
                 enddo
a1788 4
              dim_counter  = 0
              var_counter  = 0
              time_counter = 0
              file_counter = 0
d1790 4
d1796 1
a1796 1
              write(*,'(''ERROR cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
d1798 1
a1798 1
              write(*,'('' GOOD cmor_close of : '',a,'' flag: '',i6)') ,trim(xw(ixw)%entry),error_flag
@


1.1
log
@Initial revision
@
text
@d26 1
a26 1
  real,dimension(:,:,:),allocatable::indat3a,indat3b,indat3c,cmordat3d,work3da,work3db
d36 1
a36 1
  integer::i,j,k,m,n,it,ivar,jvar,length,iexp,jexp,ixw,ilev,ic
a42 16
  xwalk_file = 'xwalk_'//trim(mycmor%table_file)//'.txt'
  !
  ! Get table information
  !
  mycmor%table_file = 'Tables/CMIP5_'//trim(mycmor%table_file)
  inquire(file=mycmor%table_file,exist=does_exist)
  if (.not.(does_exist)) then
     write(*,*) 'Cannot find ',trim(mycmor%table_file),'. Dying.'
     stop
  endif
  !
  ! Get "crossxwalk" (xwalk) information
  !   Provides information on relationship between CMOR variables and
  !   model variables
  !
  call load_xwalk(xwalk_file)
d56 16
a125 1
              write(*,'(''read_att_text, time_units: '',a)') trim(time_units)
d224 1
a224 1
        case ('msftmyz','msftbarot')
d228 2
a233 2
        spval=var_info(var_found(1,1))%missing_value
        !
d245 1
a245 1
        case ('thetao','so','agessc','uo','vo','rhopoto','cfc11','wmo','wmosq')
d278 7
a284 1
        case default
d296 6
a301 1
        write(*,'(''called cmor_variable, table_entry, varid: '',a,2x,i10)') trim(xw(ixw)%entry),cmor_var_id
d312 1
d330 1
a330 1
              case ( 1152 ) ! RCP, skip 2005
d342 1
a342 1
                    indat3a = spval
d357 1
d359 1
a359 1
                 write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d363 16
a378 7
              cmor_filename = ' '
              error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
              if (error_flag < 0) then
                 write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                 stop
              else
                 write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
a379 1
              call close_cdf(myncid(ifile,1))
d389 1
a389 1
           ! sos: SALT at k=1, multiply by 1000 to maintain identity between g kg-1 and psu
d393 50
a442 49
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 !
                 do n = 1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                 enddo
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 select case (ntimes(ifile,ivar))
                 case ( 1152 ) ! RCP, skip 2005
                    nchunks(ifile) = 1
                    tidx1(1:nchunks(ifile)) = 13
                 case default
                    nchunks(ifile)   = 1
                    tidx1(1:nchunks(ifile)) =  1
                 end select
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
                 do ic = 1,nchunks(ifile)
                    do it = tidx1(ic),tidx2(ic)
                       time_counter = it
                       !
                       indat3a = spval
                       call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat3a)
                       where (indat3a(:,:,1) /= spval)
                          cmordat2d = indat3a(:,:,1)*1000.
                       endwhere
                       !
                       tval(1) = time(it) ; tbnd(1,1) = time_bnds(1,it) ; tbnd(2,1) = time_bnds(2,it)
                       error_flag = cmor_write(          &
                            var_id        = cmor_var_id, &
                            data          = cmordat2d,   &
                            ntimes_passed = 1,           &
                            time_vals     = tval,        &
                            time_bnds     = tbnd)
                       if (error_flag < 0) then
                          write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                          stop
                       endif
                    enddo
                    write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d444 1
a444 3
                 call close_cdf(myncid(ifile,ivar))
                 if (allocated(time))      deallocate(time)
                 if (allocated(time_bnds)) deallocate(time_bnds)
d446 19
d494 2
a495 2
                 select case (ntimes(ifile,ivar))
                 case ( 1152 ) ! RCP, skip 2005
d502 1
a502 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
d507 1
a507 1
                       indat2a = spval
a522 9
                    !
                    cmor_filename = ' '
                    error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                    if (error_flag < 0) then
                       write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                       stop
                    else
                       write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
                    endif
d528 4
d561 2
a562 2
                 select case (ntimes(ifile,ivar))
                 case ( 1152 ) ! RCP, skip 2005
d569 1
a569 1
                 tidx2(nchunks(ifile)) = ntimes(ifile,ivar)
d574 1
a574 1
                       indat2a = spval
d576 1
a576 1
                       where (indat2a /= spval)
a592 11
                    !
                    if ((it-1) /= tidx2(ic)) then
                       cmor_filename = ' '
                       error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
                       if (error_flag < 0) then
                          write(*,'(''ERROR close & preserve: '',a)') cmor_filename(1:128)
                          stop
                       else
                          write(*,'('' GOOD close & preserve: '',a)') cmor_filename(1:128)
                       endif
                    endif
d598 4
d611 1
a611 1
           ! thetao,agessc,uo,vo,rhopoto: No changes
d632 3
d663 1
a663 1
                       indat3a = spval
d693 4
d704 1
a704 1
        case ('wmo','wmosq')
d706 1
a706 1
           ! wmo,wmosq: Multiply WVEL (WVEL2) by PD to get vertical mass transport
d727 3
d758 1
a758 1
                       indat3a = spval
d760 3
d791 4
d802 119
a920 1
        case ('masso')
d922 1
a922 1
           ! masso - integrate density (PD) over ocean volume
d924 1
a924 1
           allocate(indat3a(nlons,nlats,nlevs))
d927 1
d930 2
a934 1
              if (.not.(allocated(indat1a)))   allocate(indat1a(ntimes(ifile,1)))
d944 26
a969 2
              nchunks(ifile)   = 1
              tidx1(nchunks(ifile)) = 1
a972 1
              indat1a = 0.
d976 4
a979 1
                    indat3a = spval
d981 1
d985 5
a989 1
                             if (indat3a(i,j,k).ne.spval) indat1a(it) = indat1a(it) + (indat3a(i,j,k)*(ocn_t_area(i,j)*ocn_t_dz(k)))
d993 12
d1006 10
d1018 34
d1053 30
a1082 12
              indat1a = indat1a/1000.
              error_flag = cmor_write(                &
                   var_id        = cmor_var_id,       &
                   data          = indat1a,           &
                   ntimes_passed = ntimes(ifile,1),&
                   time_vals     = time,              &
                   time_bnds     = time_bnds)
              if (error_flag < 0) then
                 write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                 stop
              endif
              write(*,'(''DONE writing '',a,'' T# '',i6,'' chunk# '',i6)') trim(xw(ixw)%entry),it-1,ic
d1084 53
a1136 9
              cmor_filename = ' '
              error_flag = cmor_close(var_id=cmor_var_id,file_name=cmor_filename,preserve=1)
              if (error_flag < 0) then
                 write(*,'(''ERROR close: '',a)') cmor_filename(1:128)
                 stop
              else
                 write(*,'('' GOOD close: '',a)') cmor_filename(1:128)
              endif
              if (allocated(indat1a)) deallocate(indat1a)
a1137 2
           if (allocated(time))      deallocate(time)
           if (allocated(time_bnds)) deallocate(time_bnds)
d1167 4
d1198 1
a1198 1
                       indat3a = spval
d1200 1
a1200 1
                       where (indat3a /= spval)
d1231 4
d1242 141
a1382 17
        case ('soga','thetaoga','zosga','zossga','zostoga')
           ! Time-dependent-only fields
           do ivar = 1,xw(ixw)%ncesm_vars
              do ifile = 1,nc_nfiles(ivar)
                 call open_cdf(myncid(ifile,ivar),trim(ncfile(ifile,ivar)),.true.)
                 call get_dims(myncid(ifile,ivar))
                 call get_vars(myncid(ifile,ivar))
                 !
                 if (.not.(allocated(time)))      allocate(time(ntimes(ifile,ivar)))
                 if (.not.(allocated(time_bnds))) allocate(time_bnds(2,ntimes(ifile,ivar)))
                 if (.not.(allocated(indat1a)))   allocate(indat1a(ntimes(ifile,ivar)))
                 !
                 indat1a = spval
                 do n=1,ntimes(ifile,ivar)
                    time_counter = n
                    call read_var(myncid(ifile,ivar),'time_bound',time_bnds(:,n))
                    call read_var(myncid(ifile,ivar),var_info(var_found(ifile,ivar))%name,indat1a(n))
a1383 15
                 !
                 time_bnds(1,1) = int(time_bnds(1,1))-1
                 time = (time_bnds(1,:)+time_bnds(2,:))/2.
                 !
                 error_flag = cmor_write(          &
                      var_id        = cmor_var_id, &
                      data          = indat1a,     &
                      ntimes_passed = ntimes(ifile,ivar), &
                      time_vals     = time,        &
                      time_bnds     = time_bnds)
                 if (error_flag < 0) then
                    write(*,'(''ERROR writing '',a,'' T# '',i6)') trim(xw(ixw)%entry),it
                    stop
                 endif
                 call close_cdf(myncid(ifile,ivar))
d1385 22
a1407 3
           write(*,'(''DONE writing '',a)') trim(xw(ixw)%entry)
           if (allocated(time))      deallocate(time)
           if (allocated(time_bnds)) deallocate(time_bnds)
d1530 2
a1531 2
                       cmordat3d = spval
                       cmordat3d(:,:,2) = spval ! Indo-Pacific not supplied
d1538 1
a1538 1
                          cmordat3d(:,:,1) = spval
d1543 1
a1543 1
                          cmordat3d(:,:,3) = spval
d1572 4
@
