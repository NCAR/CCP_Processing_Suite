#!/bin/sh
#
if [ $# -ne 4 ] ; then
   echo "Usage: ./Process_Setup CASE TYPE DO_PROC DO_CMIP"
   echo "All four arguments REQUIRED:"
   echo "1: Case name"
   echo "2: Type must be one of [atmm atmd lndm ocnm icem]"
   echo "3: Do single field processing [0 = NO, all other = YES]"
   echo "4: Do CMIP-style processing   [0 = NO, all other = YES]"
   exit 1
elif [ $# -eq 4 ] ; then
   CASE=$1 ; export CASE
   TYPE=$2 ; export TYPE
  IPROC=$3 ; export IPROC
  ICMIP=$4 ; export ICMIP
fi
#
# Set up a bunch of stuff
#
if [ $TYPE != "atmm" ] ; then
  if [ $TYPE != "atmd" ] ; then
    if [ $TYPE != "lndm" ] ; then
      if [ $TYPE != "ocnm" ] ; then
        if [ $TYPE != "icem" ] ; then
          echo "Type must be one of [atmm atmd lndm ocnm icem]"
          exit 1
        fi
      fi
    fi
  fi
fi
#
#
# Extract information from "experiments.txt"
#
#  Columns   Field
#   1 -  39  CCSM case name
#  40 -  41  Location (NC = NCAR; NE = NERSC; OR = ORNL)
#  45 -  64  Very brief description and/or PCMDI name (n/a if not applicable)
#  65 -  69  Realization number (<=4 digits) (0 if not applicable)
#  70 -  72  Is a CMIP3 (cm3), CMIP5 (cm5), or ByVar-only (N/A) experiment?
#  75 - 100  Parent CCSM case name
# 105 - 114  Branch date (yyyy-mm-dd, "none" if out-of-the-box)
# 120 - 123  Year began
# 125 - 128  Year ended
# 130 - 138  Resolution
# 140 - 149  Hardware
# 150 - end  History file location on archive
#
EXPFILE=${HOME}/CCP_Processing_Suite/experiments.txt ; export EXPFILE
if [ -f $EXPFILE ] ; then
  LOCATION=`egrep "^$CASE " $EXPFILE | cut -c40- | cut -d" " -f1`
      CMIP=`egrep "^$CASE " $EXPFILE | cut -c70- | cut -d" " -f1`
  if [ "$CMIP" = "N/A" ] ; then
      CMIP="byv";export $CMIP
  fi
else
  echo "Cannot find "$EXPFILE". EXIT"
  exit 1
fi
#
if ! [ $LOCATION ] ; then
  echo "Unable to build script because case '"$CASE"' not found in "$EXPFILE
  exit 1
fi
#
# Start to build processing script
#
CCPS_SCRIPT=${CASE}_${TYPE}_process.sh
rm -f $CCPS_SCRIPT
#
case "$LOCATION" in
  NC )                                        # NCAR experiments
    echo "#!/bin/sh" > $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" | sed -e "s/xxxTYPExxx/$TYPE/g" \
                                   | sed -e "s/xxxPROCxxx/$PROC/g" | sed -e "s/xxxCMIPxxx/$CMIP/g" \
                                   >> $CCPS_SCRIPT ;;
  NE )                                        # NERSC experiments
    cat ./batch_cmds_NERSC         >> $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" | sed -e "s/xxxTYPExxx/$TYPE/g" \
                                   | sed -e "s/xxxPROCxxx/$PROC/g" | sed -e "s/xxxCMIPxxx/$CMIP/g" \
                                   >> $CCPS_SCRIPT ;;
  OR )                                        # ORNL experiments
    cat ./batch_cmds_ORNL          >> $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" | sed -e "s/xxxTYPExxx/$TYPE/g" \
                                   | sed -e "s/xxxPROCxxx/$PROC/g" | sed -e "s/xxxCMIPxxx/$CMIP/g" \
                                   >> $CCPS_SCRIPT ;;
  * )
    echo "Unable to build script because "$LOCATION" not found in "$EXPFILE
    exit 1 ;;
esac
#
chmod +x $CCPS_SCRIPT
echo $CCPS_SCRIPT" ready to run"
#
exit
