#!/bin/sh
#
if [ $# -ne 5 ] ; then
   echo "Usage: ./Process_Setup CASE HIST TPER DO_PROC DO_CMIP"
   echo "All four arguments REQUIRED:"
   echo "1: CASE name"
   echo "2: HIST name - usually one of [cam2.h0 cam2.h1 cam2.h2 clm.h0 pop.h csim.h cice.h etc]"
   echo "3: TPER time period of above HIST type - must be one of [mon day hr6 hr3]"
   echo "4: PROC - do single field processing [0 = NO, all other = YES]"
   echo "5: CMIP - do CMIP-style processing   [0 = NO, all other = YES]"
   exit 1
elif [ $# -eq 5 ] ; then
   CASE=$1 ; export CASE
   HIST=$2 ; export HIST
   TPER=$3 ; export TPER
   DOPR=$4 ; export DOPR
   DOCM=$5 ; export DOCM
fi
#
# Set up a bunch of stuff
#
if [ $TPER != "mon" ] ; then
  if [ $TPER != "day" ] ; then
    if [ $TPER != "hr6" ] ; then
      if [ $TPER != "hr3" ] ; then
        echo "TPER must be one of [mon day hr6 hr3]"
        exit 1
      fi
    fi
  fi
fi
#
# Extract information from "experiments.txt"
#
#  Columns   Field
#   1 -  45  CCSM case name
#  46 -  47  Location (NC = NCAR; NE = NERSC; OR = ORNL)
#  50 -  64  Official MIP name, or very brief description (N/A if not applicable)
#  65 -  74  RIP code (cm5) or realization number (cm3) (N/A if not applicable)
#  75 -  79  MIP (cm3 or cm5) experiment (N/A if not applicable)
#  80 - 124  RUN_REFCASE (parent case)
# 125 - 139  RUN_REFDATE (branch date, yyyy-mm-dd)
# 140 - 149  years of experiment (YYYY if unknown)
# 150 - 159  GRID (resolution)
# 160 - 179  COMPSET (N/A if not applicable)
# 180 - 199  REPOTAG (N/A if not applicable)
# 200 - 219  Calendar dates of simulation execution (yyyy/mm-yyyy/mm)
# 220 - 229  MACH (hardware)
# 230 - end  DOUT_L_MSROOT (history file location on archive)
#

EXPFILE=${HOME}/CCP_Processing_Suite/experiments.txt ; export EXPFILE
if [ -f $EXPFILE ] ; then
  LOCATION=`egrep "^$CASE " $EXPFILE | cut -c46- | cut -d" " -f1`
      CMIP=`egrep "^$CASE " $EXPFILE | cut -c75- | cut -d" " -f1`
  if [ "$CMIP" = "N/A" ] ; then
      CMIP="byv";export $CMIP
  fi
else
  echo "Cannot find "$EXPFILE". EXIT"
  exit 1
fi
#
if ! [ $LOCATION ] ; then
  echo "Unable to build script because case '"$CASE"' not found in "$EXPFILE
  exit 1
fi
#
# Start to build processing script
#
CCPS_SCRIPT=${CASE}_${HIST}_process.sh
rm -f $CCPS_SCRIPT
#
case "$LOCATION" in
  NC )                                        # NCAR experiments
    echo "#!/bin/sh" > $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" \
                                   | sed -e "s/xxxHISTxxx/$HIST/g" \
                                   | sed -e "s/xxxTPERxxx/$TPER/g" \
                                   | sed -e "s/xxxPROCxxx/$DOPR/g" \
                                   | sed -e "s/xxxCMIPxxx/$DOCM/g" \
                                   >> $CCPS_SCRIPT ;;
  NE )                                        # NERSC experiments
    cat ./NERSC_batch              >> $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" \
                                   | sed -e "s/xxxHISTxxx/$HIST/g" \
                                   | sed -e "s/xxxTPERxxx/$TPER/g" \
                                   | sed -e "s/xxxPROCxxx/$DOPR/g" \
                                   | sed -e "s/xxxCMIPxxx/$DOCM/g" \
                                   >> $CCPS_SCRIPT ;;
  OR )                                        # ORNL experiments
    cat ./ORNL_batch               >> $CCPS_SCRIPT
    cat ./process_${CMIP}_template | sed -e "s/xxxCASExxx/$CASE/g" \
                                   | sed -e "s/xxxHISTxxx/$HIST/g" \
                                   | sed -e "s/xxxTPERxxx/$TPER/g" \
                                   | sed -e "s/xxxPROCxxx/$DOPR/g" \
                                   | sed -e "s/xxxCMIPxxx/$DOCM/g" \
                                   >> $CCPS_SCRIPT ;;
  * )
    echo "Unable to build script because "$LOCATION" not found in "$EXPFILE
    exit 1 ;;
esac
#
chmod +x $CCPS_SCRIPT
echo ""
echo $CCPS_SCRIPT" ready to run"
echo ""
#
echo "Run script now? (Y only, all else NO)"
read DORUN
#
if [ "$DORUN" = "Y" ] ; then
  echo "Running "${CCPS_SCRIPT}
  case "$LOCATION" in
    NC )
      ( ./${CCPS_SCRIPT} > log.${CCPS_SCRIPT} 2>&1 & ) ;;
    NE )
      ( ./${CCPS_SCRIPT} > log.${CCPS_SCRIPT} 2>&1 & ) ;;
    OR ) 
      ( /usr/bin/qsub ./${CCPS_SCRIPT} ) ;;
    * )
      echo "Unable to run script because "$LOCATION" not found in "$EXPFILE
      exit 1 ;;
  esac
else
  echo "Will not run "${CCPS_SCRIPT}
fi
